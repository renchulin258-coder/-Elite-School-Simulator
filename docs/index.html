<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡é•¿æ¨¡æ‹Ÿå™¨</title>
    <style>
        /* ä¿æŒåŸæœ‰CSSä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e6f7ff 0%, #87CEEB 100%);
            min-height: 100vh;
            padding: 15px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(135, 206, 235, 0.25);
            overflow: hidden;
            border: 2px solid #4da6ff;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(90deg, #1e5b9e, #4da6ff);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header-sub {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .time-display {
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 15px;
            display: inline-block;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
        }
        
        /* å­¦æ ¡èµ„é‡‘æ˜¾ç¤º */
        .school-funds {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: grid;
            grid-template-columns: 2.5fr 1.5fr;
            gap: 20px;
            padding: 20px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* å­¦æ ¡å±æ€§å¡ç‰‡ */
        .school-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .school-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fdff);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #b3e0ff;
            text-align: center;
            box-shadow: 0 4px 12px rgba(135, 206, 235, 0.1);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e5b9e;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #5d9cec;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* å¹´åº¦è¡ŒåŠ¨ */
        .annual-actions {
            background: linear-gradient(135deg, #ffffff, #f8fdff);
            padding: 22px;
            border-radius: 12px;
            border: 1px solid #e0f0ff;
            box-shadow: 0 4px 12px rgba(135, 206, 235, 0.1);
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .action-btn {
            padding: 16px;
            background: linear-gradient(135deg, #4da6ff, #1e90ff);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            min-height: 80px;
        }
        
        .action-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e90ff, #4da6ff);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.3);
        }
        
        .action-btn:disabled {
            background: linear-gradient(135deg, #cccccc, #aaaaaa);
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        
        .action-btn.executed {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .action-cost {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255, 255, 255, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* å½“å‰å­¦ç”Ÿå±æ€§ */
        .current-students {
            background: linear-gradient(135deg, #ffffff, #f0fff4);
            padding: 22px;
            border-radius: 12px;
            border: 1px solid #66cc99;
            box-shadow: 0 4px 12px rgba(102, 204, 153, 0.1);
        }
        
        .student-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 18px;
        }
        
        @media (max-width: 768px) {
            .student-stats {
                grid-template-columns: 1fr;
            }
        }
        
        .student-stat {
            background: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #b3e0ff;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* å³ä¾§é¢æ¿ */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* å¤§å­¦åˆä½œå…³ç³»é¢æ¿ */
        .university-panel {
            background: linear-gradient(135deg, #fff9e6, #fff5e6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #ffd166;
            box-shadow: 0 4px 12px rgba(255, 209, 102, 0.1);
            flex: 0 0 auto;
        }
        
        .university-category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .category-tab {
            padding: 8px 14px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .category-tab:hover {
            background: #e0e0e0;
        }
        
        .category-tab.active {
            background: #4da6ff;
            color: white;
            font-weight: bold;
        }
        
        .university-list {
            max-height: 220px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .university-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
        }
        
        .university-info {
            flex: 1;
        }
        
        .university-name {
            font-weight: bold;
            color: #1e5b9e;
            margin-bottom: 3px;
            font-size: 0.95rem;
        }
        
        .university-details {
            font-size: 0.75rem;
            color: #666;
        }
        
        .university-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }
        
        .status-none { 
            background: #f0f0f0; 
            color: #666; 
        }
        .status-partner { 
            background: #e6f7ff; 
            color: #1e5b9e; 
        }
        .status-special { 
            background: #fff5e6; 
            color: #cc7a00; 
        }
        .status-deep { 
            background: #f0fff4; 
            color: #27ae60; 
        }
        
        .university-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .university-action-btn {
            padding: 5px 10px;
            background: #4da6ff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .university-action-btn:hover {
            background: #1e90ff;
        }
        
        .university-action-btn.cancel {
            background: #e74c3c;
        }
        
        .university-action-btn.cancel:hover {
            background: #c0392b;
        }
        
        .university-action-btn.detail {
            background: #9b59b6;
        }
        
        .university-action-btn.detail:hover {
            background: #8e44ad;
        }
        
        .tier-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 6px;
        }
        
        .tier-top { 
            background: #ffd700; 
            color: #333; 
        }
        .tier-985 { 
            background: #ff9966; 
            color: white; 
        }
        .tier-211 { 
            background: #66cc99; 
            color: white; 
        }
        .tier-double { 
            background: #4da6ff; 
            color: white; 
        }
        
        /* æ¯•ä¸šç”Ÿæˆå°± */
        .graduate-panel {
            background: linear-gradient(135deg, #e6f7ff, #d4edff);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #b3e0ff;
            flex: 0 0 auto;
        }
        
        .overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
        }
        
        /* å‘å±•è¿›åº¦ - æ”¹ä¸ºè“ç™½é…è‰² */
        .progress-panel {
            background: linear-gradient(135deg, #e6f7ff, #d4edff);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #4da6ff;
            flex: 0 0 auto;
            box-shadow: 0 4px 12px rgba(77, 166, 255, 0.1);
        }
        
        /* é¢å¤–æ”¯å‡ºæŒ‰é’® - æ”¹ä¸ºè“è‰² */
        .extra-expense-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4da6ff, #1e90ff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .extra-expense-btn:hover {
            background: linear-gradient(135deg, #1e90ff, #4da6ff);
            transform: translateY(-2px);
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 16px 28px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            margin-top: 15px;
            width: 100%;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #cccccc, #aaaaaa);
            cursor: not-allowed;
            transform: none;
        }
        
        /* å¼¹çª— */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f8fdff);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #4da6ff;
            cursor: default;
        }
        
        .modal-header {
            background: linear-gradient(90deg, #1e5b9e, #4da6ff);
            color: white;
            padding: 22px 28px;
            border-radius: 14px 14px 0 0;
        }
        
        .modal-body {
            padding: 28px;
        }
        
        /* æ¸¸æˆç»“æŸ */
        .ending-screen {
            text-align: center;
            padding: 35px 25px;
        }
        
        .ending-title {
            font-size: 2.2rem;
            color: #1e5b9e;
            margin-bottom: 18px;
        }
        
        .ending-score {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 25px 0;
            color: #2ecc71;
        }
        
        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }
        
        /* åˆ†æ•°åˆ†å¸ƒæ¡ */
        .score-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: #f8fdff;
            border-radius: 6px;
        }
        
        .score-label {
            width: 130px;
            font-size: 0.9rem;
            color: #5d9cec;
            font-weight: 500;
        }
        
        .score-bar {
            flex: 1;
            height: 22px;
            background: #e0f0ff;
            border-radius: 6px;
            overflow: hidden;
            margin: 0 18px;
        }
        
        .score-fill {
            height: 100%;
            border-radius: 6px;
        }
        
        .score-count {
            width: 60px;
            text-align: right;
            font-weight: bold;
            color: #1e5b9e;
            font-size: 1rem;
        }
        
        /* æ•°æ®é¢æ¿ */
        .data-panel {
            max-width: 650px;
            max-height: 80vh;
        }
        
        .data-section {
            margin: 18px 0;
            padding: 18px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0f0ff;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        /* æˆå°±å¾½ç«  */
        .achievement-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffcc00);
            color: #333;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            margin: 4px;
            box-shadow: 0 2px 4px rgba(255, 204, 0, 0.2);
        }
        
        /* è¡ŒåŠ¨æ•ˆæœåŒºå— - é‡æ–°è®¾è®¡ */
        .effect-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .effect-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0f0ff;
            box-shadow: 0 4px 8px rgba(77, 166, 255, 0.1);
        }
        
        .effect-value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #2ecc71;
            margin: 8px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .effect-label {
            font-size: 0.9rem;
            color: #5d9cec;
            font-weight: 500;
        }
        
        /* èµ„é‡‘æç¤º */
        .money-hint {
            background: linear-gradient(135deg, #e6f7ff, #d4edff);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #b3e0ff;
            font-size: 0.9rem;
            color: #1e5b9e;
            text-align: center;
        }
        
        /* å­¦æ ¡æ•°æ®æç¤º */
        .stats-hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #5d9cec;
            text-align: center;
        }
        
        /* ç®€æ´è¡ŒåŠ¨é¢æ¿ */
        .action-result-simple {
            background: #f0fff4;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .action-result-simple h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        /* æ”¯å‡ºé¡¹ç›®å¼¹çª—æ ·å¼ */
        .expense-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .expense-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0f0ff;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(77, 166, 255, 0.1);
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .expense-name {
            font-weight: bold;
            color: #1e5b9e;
            font-size: 1.05rem;
        }
        
        .expense-cost {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .expense-effect {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* å¤§å­¦åˆä½œå¼¹çª—æ ·å¼ */
        .university-benefits {
            margin: 15px 0;
            padding: 15px;
            background: #f8fdff;
            border-radius: 10px;
            border: 1px solid #b3e0ff;
        }
        
        .benefit-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px dashed #e0f0ff;
        }
        
        .benefit-item:last-child {
            border-bottom: none;
        }
        
        .benefit-name {
            color: #1e5b9e;
            font-weight: 500;
        }
        
        .benefit-value {
            color: #2ecc71;
            font-weight: bold;
        }
        
        /* æ¯•ä¸šç”Ÿå†å¹´æ•°æ®è¡¨æ ¼ */
        .yearly-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.85rem;
        }
        
        .yearly-data-table th {
            background: #e6f7ff;
            color: #1e5b9e;
            padding: 10px;
            text-align: center;
            border: 1px solid #b3e0ff;
        }
        
        .yearly-data-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e0f0ff;
        }
        
        .yearly-data-table tr:nth-child(even) {
            background: #f8fdff;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0f0ff;
            border-radius: 5px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4da6ff, #1e90ff);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ« æ ¡é•¿æ¨¡æ‹Ÿå™¨</h1>
            <div class="header-sub">30å¹´æ ¡é•¿ç”Ÿæ¶¯ï¼Œä»é›¶æ‰“é€ é¡¶å°–åæ ¡</div>
            <div class="time-display" id="timeDisplay">ç¬¬1å¹´ Â· å…±30å¹´</div>
            <div class="school-funds" id="schoolFunds">ğŸ’° èµ„é‡‘ï¼š120ä¸‡</div>
        </div>
        
        <!-- èµ„é‡‘æç¤º -->
        <div class="money-hint" style="margin: 0 20px; border-radius: 0 0 8px 8px; text-align: center;">
            æ¯å¹´è‡ªåŠ¨æ”¶å–å­¦è´¹ï¼š<span id="tuitionInfo">90ä¸‡</span>ï¼ˆ0.1ä¸‡/äººÃ—900äººï¼‰
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panel">
                <!-- å­¦æ ¡å±æ€§ -->
                <div>
                    <h3 style="margin-bottom: 15px; color: #1e5b9e; padding-left: 10px; border-left: 4px solid #4da6ff;">ğŸ« å­¦æ ¡æ ¸å¿ƒæ•°æ®</h3>
                    <div class="school-stats" id="schoolStats">
                        <!-- åŠ¨æ€ç”Ÿæˆ - åªæ˜¾ç¤ºå››ä¸ªæ ¸å¿ƒæ•°æ® -->
                    </div>
                    <div class="stats-hint">
                        å­¦æ ¡æ•°æ®è¶Šé«˜ï¼Œå­¦ç”Ÿè´¨é‡è¶Šå¥½ï¼Œå­¦è´¹æ”¶å…¥ä¹Ÿè¶Šé«˜
                    </div>
                </div>
                
                <!-- å¹´åº¦è¡ŒåŠ¨ -->
                <div class="annual-actions">
                    <h3 style="margin-bottom: 15px; color: #1e5b9e; padding-left: 10px; border-left: 4px solid #4da6ff;">ğŸ“‹ æœ¬å¹´åº¦å‘å±•è®¡åˆ’</h3>
                    <div style="text-align: center; color: #5d9cec; margin: 15px 0; padding: 12px; background: #f8fdff; border-radius: 8px;">
                        ç²¾åŠ›å€¼ï¼š<span id="energyRemaining">2</span>/2ç‚¹ï¼ˆæ¯å¹´æœ€å¤šæ‰§è¡Œ2é¡¹è®¡åˆ’ï¼‰
                    </div>
                    
                    <div class="actions-grid" id="actionsGrid">
                        <!-- è¡ŒåŠ¨æŒ‰é’®ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <!-- é¢å¤–æ”¯å‡ºé€‰é¡¹ -->
                    <div style="margin-top: 15px;">
                        <button class="extra-expense-btn" onclick="showExtraExpensesModal()">
                            ğŸ’° æŸ¥çœ‹å…¶ä»–æ”¯å‡ºé¡¹ç›®
                        </button>
                    </div>
                    
                    <button class="btn" id="nextYearBtn" onclick="advanceYear()">
                        è¿›å…¥ä¸‹ä¸€å¹´
                    </button>
                </div>
                
                <!-- å½“å‰å­¦ç”Ÿå±æ€§ -->
                <div class="current-students">
                    <h3 style="margin-bottom: 15px; color: #2d8f4e; padding-left: 10px; border-left: 4px solid #66cc99;">ğŸ“ å½“å‰å­¦ç”ŸçŠ¶å†µ</h3>
                    <div class="student-stats">
                        <div class="student-stat">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #1e5b9e; margin: 12px 0;">
                                <span id="grade1Avg">320</span>åˆ†
                            </div>
                            <div style="color: #5d9cec; font-weight: 500;">é«˜ä¸€å¹´çº§</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                                <span id="grade1Count">300</span>äºº
                            </div>
                        </div>
                        <div class="student-stat">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #1e5b9e; margin: 12px 0;">
                                <span id="grade2Avg">340</span>åˆ†
                            </div>
                            <div style="color: #5d9cec; font-weight: 500;">é«˜äºŒå¹´çº§</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                                <span id="grade2Count">300</span>äºº
                            </div>
                        </div>
                        <div class="student-stat">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #1e5b9e; margin: 12px 0;">
                                <span id="grade3Avg">360</span>åˆ†
                            </div>
                            <div style="color: #5d9cec; font-weight: 500;">é«˜ä¸‰å¹´çº§</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                                <span id="grade3Count">300</span>äºº
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 18px; font-size: 0.9rem; color: #666; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0f0ff;">
                        ğŸ’¡ æœ¬å±Šé«˜ä¸‰æ¯•ä¸šé¢„æµ‹ï¼š<span id="predictedTop">0</span>æ¸…åŒ— Â· 
                        <span id="predicted985">0</span>985 Â· 
                        <span id="predicted211">0</span>211 Â· 
                        <span id="predictedFirst">0</span>ä¸€æœ¬
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <!-- å¤§å­¦åˆä½œå…³ç³» -->
                <div class="university-panel">
                    <h3 style="margin-bottom: 12px; color: #cc7a00; padding-left: 10px; border-left: 4px solid #ffd166;">ğŸ“ å¤§å­¦åˆä½œå…³ç³»</h3>
                    <div class="university-category-tabs" id="universityTabs">
                        <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±»æ ‡ç­¾ -->
                    </div>
                    <div class="university-list" id="universityList">
                        <!-- åŠ¨æ€ç”Ÿæˆå¤§å­¦åˆ—è¡¨ -->
                    </div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #666; text-align: center;">
                        å·²å»ºç«‹åˆä½œå…³ç³»ï¼š<span id="establishedPartnerships">0</span>/10æ‰€å¤§å­¦
                    </div>
                </div>
                
                <!-- æ¯•ä¸šç”Ÿæˆå°± -->
                <div class="graduate-panel">
                    <h3 style="margin-bottom: 12px; color: #1e5b9e; padding-left: 10px; border-left: 4px solid #4da6ff;">ğŸ† æ¯•ä¸šç”Ÿæˆå°±</h3>
                    
                    <div class="overview-item">
                        <span>ç´¯è®¡æ¯•ä¸šç”Ÿ</span>
                        <span><strong id="totalGraduates">0</strong>äºº</span>
                    </div>
                    <div class="overview-item">
                        <span>æ¸…åŒ—å½•å–</span>
                        <span><strong id="totalTopStudents">0</strong>äºº</span>
                    </div>
                    <div class="overview-item">
                        <span>985å½•å–</span>
                        <span><strong id="total985">0</strong>äºº</span>
                    </div>
                    <div class="overview-item">
                        <span>211å½•å–</span>
                        <span><strong id="total211">0</strong>äºº</span>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <button onclick="showGraduateDataPanel()" style="padding: 10px 15px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            ğŸ“Š æŸ¥çœ‹è¯¦ç»†æ¯•ä¸šç”Ÿæ•°æ®
                        </button>
                    </div>
                </div>
                
                <!-- å‘å±•è¿›åº¦ -->
                <div class="progress-panel">
                    <h3 style="margin-bottom: 12px; color: #1e5b9e; padding-left: 10px; border-left: 4px solid #4da6ff;">ğŸ“ˆ å‘å±•è¿›åº¦</h3>
                    <div style="font-size: 0.9rem; color: #666; line-height: 1.6; padding: 10px; background: white; border-radius: 8px;" id="progressTip">
                        ç¬¬1å¹´ï¼šä»é›¶å¼€å§‹ï¼Œå­¦ç”Ÿåˆ†æ•°é›†ä¸­åœ¨300-400åˆ†ï¼Œé‡ç‚¹æå‡åŸºç¡€æ•™å­¦è´¨é‡
                    </div>
                    <div style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem;">
                            <span style="color: #5d9cec; font-weight: 500;">ç¬¬ <span id="currentYear">1</span> / 30 å¹´</span>
                            <span style="color: #5d9cec; font-weight: 500;">å­¦ç”Ÿè´¨é‡ï¼š<span id="studentQuality">C</span></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="yearProgress" style="width: 3.33%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¡ŒåŠ¨ç»“æœå¼¹çª— -->
    <div class="modal hidden" id="actionResultModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;" id="actionResultTitle">è¡ŒåŠ¨å®Œæˆ</h2>
            </div>
            <div class="modal-body">
                <div id="actionResults">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('actionResultModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¯•ä¸šç”ŸæŠ¥å‘Šå¼¹çª— -->
    <div class="modal hidden" id="graduateReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;">ğŸ“ ç¬¬ <span id="graduateYear">3</span> å±Šæ¯•ä¸šç”ŸæŠ¥å‘Š</h2>
            </div>
            <div class="modal-body">
                <div id="graduateReportContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('graduateReportModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¯•ä¸šç”Ÿæ•°æ®å¼¹çª— -->
    <div class="modal hidden" id="graduateDataModal">
        <div class="modal-content data-panel">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;">ğŸ“Š æ¯•ä¸šç”Ÿæ•°æ®åˆ†æ</h2>
            </div>
            <div class="modal-body">
                <div id="graduateDataContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('graduateDataModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="modal hidden" id="gameOverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;" id="endingTitle">æ ¡é•¿ç”Ÿæ¶¯ç»“æŸ</h2>
            </div>
            <div class="modal-body">
                <div id="endingContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('gameOverModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">å…³é—­</button>
                    <button onclick="startNewGameWithLegacy()" style="padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer;">æ–°æ¸¸æˆ+</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¤§å­¦è¯¦æƒ…å¼¹çª— -->
    <div class="modal hidden" id="universityDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;" id="universityDetailTitle">å¤§å­¦è¯¦æƒ…</h2>
            </div>
            <div class="modal-body">
                <div id="universityDetailContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('universityDetailModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¢å¤–æ”¯å‡ºå¼¹çª— -->
    <div class="modal hidden" id="extraExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;">ğŸ’° å…¶ä»–æ”¯å‡ºé¡¹ç›®</h2>
            </div>
            <div class="modal-body">
                <div id="extraExpenseContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('extraExpenseModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¤§å­¦åˆä½œå¼¹çª— -->
    <div class="modal hidden" id="universityPartnershipModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; position: relative;" id="universityPartnershipTitle">å»ºç«‹å¤§å­¦åˆä½œå…³ç³»</h2>
            </div>
            <div class="modal-body">
                <div id="universityPartnershipContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('universityPartnershipModal')" style="padding: 10px 20px; background: #4da6ff; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== é‡æ–°è®¾è®¡çš„æ•°å€¼ç³»ç»Ÿ ====================
        const gameState = {
            year: 1,
            maxYears: 30,
            energy: 2,
            actionsTaken: 0,
            totalActions: 0,
            
            // å­¦æ ¡å±æ€§ - å››å¤§æ ¸å¿ƒæ•°æ®ï¼ˆè°ƒæ•´åˆå§‹å€¼ï¼Œé™ä½å¢é€Ÿï¼‰
            money: 120, // åˆå§‹èµ„é‡‘
            comprehensiveQuality: 15,    // ç»¼åˆè´¨é‡ï¼ˆåŸç»¼åˆæ°´å¹³ï¼‰- é™ä½åˆå§‹å€¼
            teacherStrength: 12,        // å¸ˆèµ„åŠ›é‡ - é™ä½åˆå§‹å€¼
            facilityLevel: 10,          // è®¾æ–½ç­‰çº§ - é™ä½åˆå§‹å€¼
            reputation: 8,              // å­¦æ ¡å£°èª‰ - é™ä½åˆå§‹å€¼
            
            // å­¦ç”Ÿæ•°æ® - ä¿®æ”¹ä¸ºå­˜å‚¨æ¯å¹´çš„å­¦ç”Ÿé˜Ÿåˆ—
            studentQueue: {
                // ç¬¬1å¹´å…¥å­¦çš„é«˜ä¸€å­¦ç”Ÿï¼ˆå½“å‰é«˜ä¸‰ï¼‰
                year1: { grade: 3, avgScore: 360, distribution: null, originalScore: 320 },
                // ç¬¬2å¹´å…¥å­¦çš„é«˜ä¸€å­¦ç”Ÿï¼ˆå½“å‰é«˜äºŒï¼‰
                year2: { grade: 2, avgScore: 340, distribution: null, originalScore: 320 },
                // ç¬¬3å¹´å…¥å­¦çš„é«˜ä¸€å­¦ç”Ÿï¼ˆå½“å‰é«˜ä¸€ï¼‰
                year3: { grade: 1, avgScore: 320, distribution: null, originalScore: 320 }
            },
            
            // å½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿæ•°æ®ï¼ˆä»studentQueueè®¡ç®—å¾—å‡ºï¼‰
            currentStudents: {
                grade1: { count: 300, avgScore: 320, distribution: null },
                grade2: { count: 300, avgScore: 340, distribution: null },
                grade3: { count: 300, avgScore: 360, distribution: null }
            },
            
            // æ¯•ä¸šç”Ÿè®°å½• - åŠ å¼ºç‰ˆ
            graduates: [],
            
            // æ¯•ä¸šç”Ÿç»Ÿè®¡
            graduateStats: {
                total: 0,
                topStudents: 0,
                top985: 0,
                top211: 0,
                firstTier: 0,
                undergraduate: 0,
                college: 0,
                low: 0,
                
                // åˆ†æ•°æ®µè®°å½•
                scoreSegments: {
                    top: [],      // 700+ æ¸…åŒ—
                    level985: [], // 650-699 985
                    level211: [], // 600-649 211
                    first: [],    // 550-599 ä¸€æœ¬
                    undergrad: [], // 500-549 æœ¬ç§‘
                    college: [],   // 450-499 ä¸“ç§‘
                    low: []       // 450ä»¥ä¸‹
                },
                
                // å†å¹´æ•°æ®è®°å½• - åŠ å¼ºç‰ˆ
                yearData: []
            },
            
            // å­¦è´¹æ”¶å…¥
            tuition: 0.1, // æ¯åå­¦ç”Ÿæ¯å¹´çš„å­¦è´¹ï¼ˆä¸‡ï¼‰
            
            // å¤§å­¦åˆä½œå…³ç³» - é‡æ–°æ’åºå’Œåˆ†ç±»
            universityRelations: {
                // æ¸…åŒ—çº§åˆ« (2æ‰€)
                'æ¸…åå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 80,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 50, reputation: 80, studentBoost: 15 },
                    tier: 'top'
                },
                'åŒ—äº¬å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 80,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 50, reputation: 80, studentBoost: 15 },
                    tier: 'top'
                },
                
                // 985çº§åˆ« - C9è”ç›Ÿé«˜æ ¡ (9æ‰€ï¼Œä½†åªæ˜¾ç¤º7æ‰€ä»¥ä¿æŒå¸ƒå±€)
                'å¤æ—¦å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 60,
                    specialAdmission: 0,
                    bonus: { teacherStrength: 40, reputation: 60 },
                    tier: '985'
                },
                'ä¸Šæµ·äº¤é€šå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 60,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 40, facilityLevel: 30 },
                    tier: '985'
                },
                'æµ™æ±Ÿå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 60,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 35, reputation: 50 },
                    tier: '985'
                },
                'å—äº¬å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 55,
                    specialAdmission: 0,
                    bonus: { teacherStrength: 35, reputation: 45 },
                    tier: '985'
                },
                'ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 55,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 45, teacherStrength: 40 },
                    tier: '985'
                },
                'å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 50,
                    specialAdmission: 0,
                    bonus: { facilityLevel: 40, comprehensiveQuality: 35 },
                    tier: '985'
                },
                'è¥¿å®‰äº¤é€šå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 50,
                    specialAdmission: 0,
                    bonus: { reputation: 45, teacherStrength: 35 },
                    tier: '985'
                },
                
                // 211çº§åˆ« - é¡¶çº§211é«˜æ ¡ (é985)
                'ä¸Šæµ·è´¢ç»å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 40,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 30, reputation: 35 },
                    tier: '211'
                },
                'ä¸­å¤®è´¢ç»å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 40,
                    specialAdmission: 0,
                    bonus: { reputation: 40, teacherStrength: 30 },
                    tier: '211'
                },
                'å¯¹å¤–ç»æµè´¸æ˜“å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 35,
                    specialAdmission: 0,
                    bonus: { reputation: 35, comprehensiveQuality: 25 },
                    tier: '211'
                },
                'åŒ—äº¬å¤–å›½è¯­å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 35,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 40, reputation: 35 },
                    tier: '211'
                },
                'ä¸­å›½æ”¿æ³•å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 35,
                    specialAdmission: 0,
                    bonus: { reputation: 45, teacherStrength: 25 },
                    tier: '211'
                },
                'è¥¿å—è´¢ç»å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 30,
                    specialAdmission: 0,
                    bonus: { reputation: 50, teacherStrength: 25 },
                    tier: '211'
                },
                
                // åŒä¸€æµçº§åˆ« - é¡¶çº§åŒä¸€æµé«˜æ ¡ (é985/211)
                'å¤©æ´¥å·¥ä¸šå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 25,
                    specialAdmission: 0,
                    bonus: { teacherStrength: 20, reputation: 25 },
                    tier: 'double'
                },
                'å—äº¬é‚®ç”µå¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 25,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 25, facilityLevel: 20 },
                    tier: 'double'
                },
                'ä¸Šæµ·ç§‘æŠ€å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 20,
                    specialAdmission: 0,
                    bonus: { teacherStrength: 30, reputation: 25 },
                    tier: 'double'
                },
                'å—æ–¹ç§‘æŠ€å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 20,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 30, facilityLevel: 25 },
                    tier: 'double'
                },
                'å—äº¬ä¿¡æ¯å·¥ç¨‹å¤§å­¦': { 
                    count: 0, 
                    status: 'none', 
                    requirement: 15,
                    specialAdmission: 0,
                    bonus: { comprehensiveQuality: 25, teacherStrength: 20 },
                    tier: 'double'
                }
            },
            
            // è¡ŒåŠ¨ä½¿ç”¨è®°å½•
            actionUses: {},
            
            // å·²æ‰§è¡Œçš„è¡ŒåŠ¨ï¼ˆæ¯å¹´é‡ç½®ï¼‰
            completedActions: new Set(),
            
            // å½“å‰é€‰ä¸­çš„å¤§å­¦åˆ†ç±»
            currentUniversityCategory: 'all',
            
            // å·²å»ºç«‹çš„åˆä½œå…³ç³»æ•°é‡
            establishedPartnerships: 0,
            maxPartnerships: 10,
            
            // å­¦æ ¡å±æ€§ä¸Šé™
            maxStat: 1000,
            
            // äºŒå‘¨ç›®ç»§æ‰¿æ•°æ®
            legacyBonuses: null,
            newGamePlus: false,
            
            // ç´¯è®¡æ¸¸æˆå¾—åˆ†
            legacyScore: 0,
            
            // æ–°å¢ï¼šç©å®¶å‘å±•å€¾å‘ç»Ÿè®¡ï¼ˆç”¨äºä¸åŒç»“å±€ï¼‰
            developmentFocus: {
                balanced: 0,      // å¹³è¡¡å‘å±•
                teaching: 0,      // æ•™å­¦å¯¼å‘
                facilities: 0,    // è®¾æ–½å¯¼å‘
                reputation: 0     // å£°èª‰å¯¼å‘
            }
        };
        
        // å¤§å­¦åˆ†ç±»å®šä¹‰ - æŒ‰è¦æ±‚çš„é¡ºåºï¼šå…¨éƒ¨ â†’ æ¸…åŒ— â†’ 985 â†’ 211 â†’ åŒä¸€æµ
        const universityCategories = {
            'all': { name: 'å…¨éƒ¨', color: '#1e5b9e' },
            'top': { name: 'æ¸…åŒ—', color: '#ffd700' },
            '985': { name: '985é«˜æ ¡', color: '#ff9966' },
            '211': { name: '211é«˜æ ¡', color: '#66cc99' },
            'double': { name: 'åŒä¸€æµ', color: '#4da6ff' }
        };
        
        // ==================== é‡æ–°è®¾è®¡çš„æ•°å€¼è®¡ç®—å‡½æ•° ====================
        
        // 1. è®¡ç®—å­¦æ ¡ç»¼åˆè¯„åˆ†ï¼ˆ0-1000åˆ†ï¼‰
        function calculateSchoolScore() {
            const weights = {
                comprehensiveQuality: 0.30, // ç»¼åˆè´¨é‡æƒé‡30%
                teacherStrength: 0.25,      // å¸ˆèµ„åŠ›é‡æƒé‡25%
                facilityLevel: 0.25,        // è®¾æ–½ç­‰çº§æƒé‡25%
                reputation: 0.20            // å­¦æ ¡å£°èª‰æƒé‡20%
            };
            
            const totalWeight = weights.comprehensiveQuality + weights.teacherStrength + 
                              weights.facilityLevel + weights.reputation;
            
            const weightedScore = 
                gameState.comprehensiveQuality * weights.comprehensiveQuality +
                gameState.teacherStrength * weights.teacherStrength +
                gameState.facilityLevel * weights.facilityLevel +
                gameState.reputation * weights.reputation;
            
            return Math.min(1000, Math.floor(weightedScore / totalWeight));
        }
        
        // 2. æ ¹æ®å­¦æ ¡è¯„åˆ†å†³å®šæ–°ç”Ÿè´¨é‡ - å¤§å¹…é™ä½å¢é€Ÿ
        function calculateNewStudentScore() {
            const schoolScore = calculateSchoolScore();
            
            // åŸºç¡€300åˆ† + å­¦æ ¡åŠ æˆï¼ˆæ¯100å­¦æ ¡åˆ†åŠ 30åˆ†ï¼‰- é™ä½åŠ æˆ
            const baseScore = 300;
            const schoolBonus = schoolScore * 0.3; // ä»0.5é™ä½åˆ°0.3
            
            let finalScore = baseScore + schoolBonus;
            
            // æ§åˆ¶èŒƒå›´ï¼š300-500åˆ†ï¼ˆæ–°ç”Ÿè´¨é‡ä¸Šé™é™ä½ï¼‰
            return Math.max(300, Math.min(500, Math.floor(finalScore)));
        }
        
        // 3. è®¡ç®—å­¦ç”Ÿåœ¨æ ¡ä¸€å¹´çš„å¢é•¿ - é™ä½å¢é•¿å¹…åº¦
        function calculateYearlyGrowth(currentScore, grade) {
            const schoolScore = calculateSchoolScore();
            
            // åŸºç¡€å¹´å¢é•¿ï¼šé«˜ä¸€8åˆ†ï¼Œé«˜äºŒ12åˆ†ï¼Œé«˜ä¸‰16åˆ† - é™ä½åŸºç¡€å¢é•¿
            let baseGrowth = 8;
            if (grade === 2) baseGrowth = 12;
            if (grade === 3) baseGrowth = 16;
            
            // å­¦æ ¡è´¨é‡å½±å“ï¼šæ¯100å­¦æ ¡åˆ†å¢åŠ 2åˆ†å¹´å¢é•¿ - é™ä½å¢é•¿ç³»æ•°
            const schoolGrowthBonus = schoolScore * 0.02; // ä»0.03é™ä½åˆ°0.02
            
            // è®¡ç®—æ€»å¢é•¿
            let totalGrowth = baseGrowth + schoolGrowthBonus;
            
            // ç¡®ä¿å¢é•¿ä¸ä¼šè¿‡é«˜ï¼ˆæ¯å¹´æœ€å¤šï¼šé«˜ä¸€25åˆ†ï¼Œé«˜äºŒ35åˆ†ï¼Œé«˜ä¸‰45åˆ†ï¼‰- é™ä½ä¸Šé™
            const maxGrowth = [25, 35, 45][grade - 1];
            totalGrowth = Math.min(maxGrowth, totalGrowth);
            
            // ç¡®ä¿åˆ†æ•°ä¸ä¼šè¶…è¿‡750åˆ†ä¸Šé™
            const newScore = currentScore + totalGrowth;
            if (newScore > 750) {
                totalGrowth = 750 - currentScore;
            }
            
            return Math.floor(totalGrowth);
        }
        
        // 4. é‡æ–°è®¾è®¡çš„åˆ†æ•°åˆ†å¸ƒç”Ÿæˆ - é™ä½é«˜åˆ†æ®µæ¯”ä¾‹
        function generateScoreDistribution(count, avgScore) {
            const schoolScore = calculateSchoolScore();
            
            // åˆ†æ•°æ®µå®šä¹‰
            const scoreRanges = [
                { min: 700, max: 750, label: '700+ æ¸…åŒ—', count: 0, requirement: 800 },
                { min: 650, max: 699, label: '650-699 985', count: 0, requirement: 600 },
                { min: 600, max: 649, label: '600-649 211', count: 0, requirement: 500 },
                { min: 550, max: 599, label: '550-599 ä¸€æœ¬', count: 0, requirement: 400 },
                { min: 500, max: 549, label: '500-549 æœ¬ç§‘', count: 0, requirement: 300 },
                { min: 450, max: 499, label: '450-499 ä¸“ç§‘', count: 0, requirement: 200 },
                { min: 300, max: 449, label: '300-449 è½æ¦œ', count: 0, requirement: 0 }
            ];
            
            // æ ¹æ®å­¦æ ¡è¯„åˆ†å’Œå­¦ç”Ÿå¹³å‡åˆ†è®¡ç®—å„æ®µäººæ•°
            let remainingCount = count;
            
            // ä»é«˜åˆ†æ®µåˆ°ä½åˆ†æ®µåˆ†é…
            for (let i = 0; i < scoreRanges.length; i++) {
                const range = scoreRanges[i];
                
                if (schoolScore >= range.requirement) {
                    // è¾¾åˆ°è¦æ±‚çš„åŸºç¡€æ¯”ä¾‹ - é™ä½æ¯”ä¾‹
                    let baseRatio = 0.015; // ä»0.02é™ä½åˆ°0.015
                    
                    // å­¦æ ¡è¯„åˆ†è¶…è¿‡è¦æ±‚çš„åŠ æˆ - é™ä½åŠ æˆç³»æ•°
                    if (range.requirement > 0) {
                        const exceedRatio = (schoolScore - range.requirement) / 100;
                        baseRatio += exceedRatio * 0.03; // ä»0.05é™ä½åˆ°0.03
                    }
                    
                    // å¹³å‡åˆ†æ•°å½±å“ï¼šæ¯100å¹³å‡åˆ†å¢åŠ 10%æ¯”ä¾‹ - é™ä½ç³»æ•°
                    const scoreRatio = (avgScore - 300) / 400; // 300-700åˆ†èŒƒå›´
                    baseRatio += scoreRatio * 0.1; // ä»0.15é™ä½åˆ°0.1
                    
                    // é™åˆ¶æœ€å¤§æ¯”ä¾‹ - é™ä½ä¸Šé™
                    const maxRatios = [0.10, 0.20, 0.30, 0.40, 0.55, 0.70, 1.0];
                    baseRatio = Math.min(baseRatio, maxRatios[i]);
                    
                    // è®¡ç®—äººæ•°
                    let segmentCount = Math.floor(count * baseRatio);
                    segmentCount = Math.min(segmentCount, remainingCount);
                    
                    scoreRanges[i].count = Math.max(0, segmentCount);
                    remainingCount -= segmentCount;
                } else {
                    scoreRanges[i].count = 0;
                }
            }
            
            // å‰©ä½™å­¦ç”Ÿåˆ†é…åˆ°æœ€ä½åˆ†æ®µ
            scoreRanges[scoreRanges.length - 1].count += remainingCount;
            
            return scoreRanges;
        }
        
        // 5. æ›´æ–°å½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿæ•°æ®
        function updateCurrentStudentsDisplay() {
            // ä»studentQueueä¸­æå–å½“å‰å„å¹´çº§æ•°æ®
            const currentYear = gameState.year;
            
            // åˆå§‹åŒ–æ˜¾ç¤ºæ•°æ®
            gameState.currentStudents = {
                grade1: { count: 300, avgScore: 0, distribution: null },
                grade2: { count: 300, avgScore: 0, distribution: null },
                grade3: { count: 300, avgScore: 0, distribution: null }
            };
            
            // éå†å­¦ç”Ÿé˜Ÿåˆ—ï¼Œåˆ†é…åˆ°å¯¹åº”çš„å¹´çº§
            Object.keys(gameState.studentQueue).forEach(key => {
                const studentGroup = gameState.studentQueue[key];
                const grade = studentGroup.grade;
                
                if (grade === 1) {
                    gameState.currentStudents.grade1.avgScore = studentGroup.avgScore;
                    gameState.currentStudents.grade1.distribution = studentGroup.distribution;
                } else if (grade === 2) {
                    gameState.currentStudents.grade2.avgScore = studentGroup.avgScore;
                    gameState.currentStudents.grade2.distribution = studentGroup.distribution;
                } else if (grade === 3) {
                    gameState.currentStudents.grade3.avgScore = studentGroup.avgScore;
                    gameState.currentStudents.grade3.distribution = studentGroup.distribution;
                }
            });
        }
        
        // 6. æ›´æ–°å­¦ç”Ÿå¹³å‡åˆ†ï¼ˆåŸºäºåˆ†å¸ƒè®¡ç®—ï¼‰
        function updateStudentAverageScore(distribution) {
            let totalScore = 0;
            let totalStudents = 0;
            
            distribution.forEach(range => {
                const rangeMid = (range.min + range.max) / 2;
                totalScore += rangeMid * range.count;
                totalStudents += range.count;
            });
            
            return totalStudents > 0 ? totalScore / totalStudents : 320;
        }
        
        // ==================== é‡æ–°è®¾è®¡çš„è¡ŒåŠ¨ç³»ç»Ÿ - ä¸‰ä¸ªæ¡£æ¬¡ ====================
        // ç¬¬ä¸€æ¡£ï¼šåŸºç¡€å»ºè®¾ï¼ˆä½æˆæœ¬ï¼Œä½æ”¶ç›Šï¼Œä¾§é‡å•é¡¹å±æ€§ï¼‰
        // ç¬¬äºŒæ¡£ï¼šå¹³è¡¡å‘å±•ï¼ˆä¸­ç­‰æˆæœ¬ï¼Œä¸­ç­‰æ”¶ç›Šï¼Œä¾§é‡ä¸¤é¡¹å±æ€§ï¼‰
        // ç¬¬ä¸‰æ¡£ï¼šä¸“é¡¹çªç ´ï¼ˆé«˜æˆæœ¬ï¼Œé«˜æ”¶ç›Šï¼Œä¾§é‡ä¸‰é¡¹å±æ€§ï¼‰
        const actions = [
            // ç¬¬ä¸€æ¡£ï¼šåŸºç¡€å»ºè®¾ç±»
            {
                id: 'basic_teaching',
                icon: 'ğŸ“š',
                name: 'åŸºç¡€æ•™å­¦æå‡',
                description: 'ä¼˜åŒ–è¯¾å ‚æ•™å­¦ï¼ŒåŠ å¼ºåŸºç¡€çŸ¥è¯†è®­ç»ƒ',
                focus: 'æ•™å­¦åŸºç¡€',
                cost: 25,
                getEffects: () => {
                    // åŸºç¡€æ•™å­¦ï¼šä¾§é‡å¸ˆèµ„åŠ›é‡å’Œç»¼åˆè´¨é‡
                    const baseQuality = 12;
                    const baseTeacher = 15;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.teaching += 1;
                    
                    return {
                        comprehensiveQuality: Math.floor(baseQuality * randomFactor),
                        teacherStrength: Math.floor(baseTeacher * randomFactor),
                        money: -25
                    };
                }
            },
            {
                id: 'basic_facilities',
                icon: 'ğŸ› ï¸',
                name: 'åŸºç¡€è®¾æ–½ç»´æŠ¤',
                description: 'ç»´æŠ¤ç°æœ‰è®¾æ–½ï¼Œæ”¹å–„åŸºæœ¬å­¦ä¹ ç¯å¢ƒ',
                focus: 'è®¾æ–½åŸºç¡€',
                cost: 30,
                getEffects: () => {
                    // åŸºç¡€è®¾æ–½ï¼šä¾§é‡è®¾æ–½ç­‰çº§
                    const baseFacility = 20;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.facilities += 1;
                    
                    return {
                        facilityLevel: Math.floor(baseFacility * randomFactor),
                        money: -30
                    };
                }
            },
            
            // ç¬¬äºŒæ¡£ï¼šå¹³è¡¡å‘å±•ç±»
            {
                id: 'teacher_training',
                icon: 'ğŸ‘¨â€ğŸ«',
                name: 'å¸ˆèµ„åŸ¹è®­è®¡åˆ’',
                description: 'ç»„ç»‡æ•™å¸ˆè¿›ä¿®ï¼Œæå‡æ•™å­¦æ°´å¹³',
                focus: 'å¸ˆèµ„å‘å±•',
                cost: 45,
                getEffects: () => {
                    // å¸ˆèµ„åŸ¹è®­ï¼šä¾§é‡å¸ˆèµ„åŠ›é‡å’Œç»¼åˆè´¨é‡
                    const baseTeacher = 25;
                    const baseQuality = 18;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.teaching += 1;
                    gameState.developmentFocus.balanced += 0.5;
                    
                    return {
                        teacherStrength: Math.floor(baseTeacher * randomFactor),
                        comprehensiveQuality: Math.floor(baseQuality * randomFactor),
                        money: -45
                    };
                }
            },
            {
                id: 'student_development',
                icon: 'ğŸ’—',
                name: 'å­¦ç”Ÿå…¨é¢å‘å±•',
                description: 'å¼€å±•è¯¾å¤–æ´»åŠ¨ï¼Œä¿ƒè¿›å­¦ç”Ÿæˆé•¿',
                focus: 'å­¦ç”Ÿå‘å±•',
                cost: 40,
                getEffects: () => {
                    // å­¦ç”Ÿå‘å±•ï¼šä¾§é‡ç»¼åˆè´¨é‡å’Œå£°èª‰
                    const baseQuality = 20;
                    const baseReputation = 18;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.balanced += 1;
                    gameState.developmentFocus.reputation += 0.5;
                    
                    return {
                        comprehensiveQuality: Math.floor(baseQuality * randomFactor),
                        reputation: Math.floor(baseReputation * randomFactor),
                        money: -40
                    };
                }
            },
            
            // ç¬¬ä¸‰æ¡£ï¼šä¸“é¡¹çªç ´ç±»
            {
                id: 'facility_upgrade',
                icon: 'ğŸ—ï¸',
                name: 'æ•™å­¦è®¾æ–½å‡çº§',
                description: 'æ›´æ–°æ•™å­¦è®¾å¤‡ï¼Œæ”¹å–„å­¦ä¹ ç¯å¢ƒ',
                focus: 'è®¾æ–½å‡çº§',
                cost: 70,
                getEffects: () => {
                    // è®¾æ–½å‡çº§ï¼šä¾§é‡è®¾æ–½ç­‰çº§ã€ç»¼åˆè´¨é‡å’Œå£°èª‰
                    const baseFacility = 35;
                    const baseQuality = 22;
                    const baseReputation = 20;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.facilities += 1.5;
                    gameState.developmentFocus.balanced += 0.5;
                    
                    return {
                        facilityLevel: Math.floor(baseFacility * randomFactor),
                        comprehensiveQuality: Math.floor(baseQuality * randomFactor),
                        reputation: Math.floor(baseReputation * randomFactor),
                        money: -70
                    };
                }
            },
            {
                id: 'elite_program',
                icon: 'â­',
                name: 'ç²¾è‹±åŸ¹å…»è®¡åˆ’',
                description: 'é‡ç‚¹åŸ¹å…»å°–å­ç”Ÿï¼Œå†²å‡»åæ ¡',
                focus: 'ç²¾è‹±æ•™è‚²',
                cost: 85,
                getEffects: () => {
                    // ç²¾è‹±è®¡åˆ’ï¼šä¾§é‡ç»¼åˆè´¨é‡ã€å¸ˆèµ„åŠ›é‡å’Œå£°èª‰
                    const baseQuality = 30;
                    const baseTeacher = 28;
                    const baseReputation = 25;
                    const randomFactor = 0.85 + Math.random() * 0.3;
                    
                    // è®°å½•å‘å±•å€¾å‘
                    gameState.developmentFocus.teaching += 1;
                    gameState.developmentFocus.reputation += 1;
                    
                    return {
                        comprehensiveQuality: Math.floor(baseQuality * randomFactor),
                        teacherStrength: Math.floor(baseTeacher * randomFactor),
                        reputation: Math.floor(baseReputation * randomFactor),
                        money: -85
                    };
                }
            }
        ];
        
        // ==================== æ˜¾ç¤ºæ›´æ–°å‡½æ•° ====================
        
        function updateAllDisplays() {
            updateTimeDisplay();
            updateSchoolStats();
            updateSchoolFunds();
            updateStudentStats();
            updateGraduatePanel();
            updatePredictedAdmissions();
            updateYearProgress();
            updateUniversityRelations();
            renderUniversityList();
            updateEnergyDisplay();
            updateStudentQuality();
            updateTuitionInfo();
            renderActionButtons();
        }
        
        function updateTimeDisplay() {
            document.getElementById('timeDisplay').textContent = `ç¬¬${gameState.year}å¹´ Â· å…±${gameState.maxYears}å¹´`;
            document.getElementById('currentYear').textContent = gameState.year;
        }
        
        function updateSchoolStats() {
            // ä¿®æ”¹ï¼šæŒ‰æ–°é¡ºåºæ˜¾ç¤ºæ ¸å¿ƒæ•°æ®
            const stats = [
                { value: gameState.comprehensiveQuality, label: 'ç»¼åˆè´¨é‡', unit: '' },
                { value: gameState.teacherStrength, label: 'å¸ˆèµ„åŠ›é‡', unit: '' },
                { value: gameState.facilityLevel, label: 'è®¾æ–½ç­‰çº§', unit: '' },
                { value: gameState.reputation, label: 'å­¦æ ¡å£°èª‰', unit: '' }
            ];
            
            const statsElement = document.getElementById('schoolStats');
            statsElement.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${Math.floor(stat.value)}${stat.unit}</div>
                </div>
            `).join('');
        }
        
        function updateSchoolFunds() {
            document.getElementById('schoolFunds').textContent = `ğŸ’° èµ„é‡‘ï¼š${Math.floor(gameState.money)}ä¸‡`;
        }
        
        function updateTuitionInfo(income = null, studentCount = null) {
            const totalStudents = 900;
            const tuitionIncome = income || (totalStudents * gameState.tuition);
            
            document.getElementById('tuitionInfo').textContent = 
                `${Math.round(tuitionIncome)}ä¸‡ï¼ˆ${gameState.tuition.toFixed(2)}ä¸‡/äººÃ—${totalStudents}äººï¼‰`;
        }
        
        function updateEnergyDisplay() {
            document.getElementById('energyRemaining').textContent = gameState.energy;
        }
        
        function updateStudentStats() {
            const grade1Avg = Math.floor(gameState.currentStudents.grade1.avgScore);
            const grade2Avg = Math.floor(gameState.currentStudents.grade2.avgScore);
            const grade3Avg = Math.floor(gameState.currentStudents.grade3.avgScore);
            
            document.getElementById('grade1Avg').textContent = grade1Avg;
            document.getElementById('grade2Avg').textContent = grade2Avg;
            document.getElementById('grade3Avg').textContent = grade3Avg;
        }
        
        function updatePredictedAdmissions() {
            if (gameState.currentStudents.grade3.distribution) {
                document.getElementById('predictedTop').textContent = gameState.currentStudents.grade3.distribution[0]?.count || 0;
                document.getElementById('predicted985').textContent = gameState.currentStudents.grade3.distribution[1]?.count || 0;
                document.getElementById('predicted211').textContent = gameState.currentStudents.grade3.distribution[2]?.count || 0;
                document.getElementById('predictedFirst').textContent = gameState.currentStudents.grade3.distribution[3]?.count || 0;
            }
        }
        
        function updateGraduatePanel() {
            document.getElementById('totalGraduates').textContent = gameState.graduateStats.total;
            document.getElementById('totalTopStudents').textContent = gameState.graduateStats.topStudents;
            document.getElementById('total985').textContent = gameState.graduateStats.top985;
            document.getElementById('total211').textContent = gameState.graduateStats.top211;
        }
        
        function updateStudentQuality() {
            const schoolScore = calculateSchoolScore();
            const avgScore = Math.floor(gameState.currentStudents.grade3.avgScore);
            
            let quality = 'C';
            if (schoolScore >= 800 && avgScore >= 650) quality = 'A+';
            else if (schoolScore >= 600 && avgScore >= 600) quality = 'A';
            else if (schoolScore >= 500 && avgScore >= 550) quality = 'B+';
            else if (schoolScore >= 400 && avgScore >= 500) quality = 'B';
            else if (schoolScore >= 300 && avgScore >= 450) quality = 'C+';
            else if (schoolScore >= 200 && avgScore >= 400) quality = 'C';
            else if (avgScore >= 350) quality = 'D';
            else quality = 'E';
            
            document.getElementById('studentQuality').textContent = quality;
        }
        
        // ==================== å­¦ç”Ÿæ•°æ®åˆå§‹åŒ– ====================
        
        function initializeStudentData() {
            try {
                // åˆå§‹åŒ–å‰ä¸‰å¹´çš„å­¦ç”Ÿé˜Ÿåˆ—
                const initialScore = calculateNewStudentScore();
                
                // ç¬¬1å¹´å…¥å­¦çš„å­¦ç”Ÿï¼ˆå½“å‰é«˜ä¸‰ï¼‰
                gameState.studentQueue.year1 = {
                    grade: 3,
                    avgScore: initialScore + 40,
                    originalScore: initialScore,
                    distribution: generateScoreDistribution(300, initialScore + 40)
                };
                
                // ç¬¬2å¹´å…¥å­¦çš„å­¦ç”Ÿï¼ˆå½“å‰é«˜äºŒï¼‰
                gameState.studentQueue.year2 = {
                    grade: 2,
                    avgScore: initialScore + 20,
                    originalScore: initialScore,
                    distribution: generateScoreDistribution(300, initialScore + 20)
                };
                
                // ç¬¬3å¹´å…¥å­¦çš„å­¦ç”Ÿï¼ˆå½“å‰é«˜ä¸€ï¼‰
                gameState.studentQueue.year3 = {
                    grade: 1,
                    avgScore: initialScore,
                    originalScore: initialScore,
                    distribution: generateScoreDistribution(300, initialScore)
                };
                
                // æ›´æ–°æ˜¾ç¤ºæ•°æ®
                updateCurrentStudentsDisplay();
                    
            } catch (error) {
                console.error("åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®æ—¶å‡ºé”™:", error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                const defaultDistribution = [
                    { min: 700, max: 750, label: '700+ æ¸…åŒ—', count: 0 },
                    { min: 650, max: 699, label: '650-699 985', count: 0 },
                    { min: 600, max: 649, label: '600-649 211', count: 0 },
                    { min: 550, max: 599, label: '550-599 ä¸€æœ¬', count: 0 },
                    { min: 500, max: 549, label: '500-549 æœ¬ç§‘', count: 0 },
                    { min: 450, max: 499, label: '450-499 ä¸“ç§‘', count: 0 },
                    { min: 300, max: 449, label: '300-449 è½æ¦œ', count: 300 }
                ];
                
                gameState.currentStudents.grade1.distribution = defaultDistribution;
                gameState.currentStudents.grade2.distribution = defaultDistribution;
                gameState.currentStudents.grade3.distribution = defaultDistribution;
            }
        }
        
        // ==================== è¡ŒåŠ¨ç³»ç»Ÿ ====================
        
        function renderActionButtons() {
            const actionsGrid = document.getElementById('actionsGrid');
            if (!actionsGrid) return;
            
            const buttonsHTML = actions.map(action => {
                const isCompleted = gameState.completedActions.has(action.id);
                const canExecute = !isCompleted && gameState.energy > 0 && gameState.money >= action.cost;
                
                return `
                    <button class="action-btn ${isCompleted ? 'executed' : ''}" 
                            onclick="executeAction('${action.id}')" 
                            ${!canExecute ? 'disabled' : ''}
                            title="${action.description}\nèŠ±è´¹ï¼š${action.cost}ä¸‡">
                        <span style="font-size: 1.5rem;">${action.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${action.name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">${action.focus}</div>
                        </div>
                        <div class="action-cost">${action.cost}ä¸‡</div>
                    </button>
                `;
            }).join('');
            
            actionsGrid.innerHTML = buttonsHTML;
            
            // æ›´æ–°ä¸‹ä¸€å¹´æŒ‰é’®
            const nextYearBtn = document.getElementById('nextYearBtn');
            if (nextYearBtn) {
                const buttonText = gameState.year === gameState.maxYears ? "å®Œæˆ30å¹´æ ¡é•¿ç”Ÿæ¶¯" : "è¿›å…¥ä¸‹ä¸€å¹´";
                nextYearBtn.textContent = buttonText;
                nextYearBtn.disabled = false;
            }
        }
        
        function executeAction(actionId) {
            const action = actions.find(a => a.id === actionId);
            if (!action) return;
            
            // æ£€æŸ¥èµ„é‡‘
            if (gameState.money < action.cost) {
                alert(`èµ„é‡‘ä¸è¶³ï¼éœ€è¦${action.cost}ä¸‡ï¼Œå½“å‰åªæœ‰${gameState.money}ä¸‡`);
                return;
            }
            
            // æ£€æŸ¥ç²¾åŠ›å’Œæ˜¯å¦å·²æ‰§è¡Œ
            if (gameState.energy === 0 || gameState.completedActions.has(actionId)) {
                return;
            }
            
            const effects = action.getEffects();
            
            // åº”ç”¨æ•ˆæœ
            applyActionEffects(effects, action.cost);
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.energy--;
            gameState.actionsTaken++;
            gameState.completedActions.add(actionId);
            
            // æ˜¾ç¤ºç»“æœ
            showActionResult(action, effects);
            
            // æ›´æ–°æ˜¾ç¤º
            updateAllDisplays();
        }
        
        function applyActionEffects(effects, cost) {
            // æ‰£é™¤èµ„é‡‘
            gameState.money = Math.max(0, gameState.money + (effects.money || -cost));
            
            // åº”ç”¨æ•ˆæœ
            if (effects.comprehensiveQuality) {
                gameState.comprehensiveQuality = Math.min(gameState.maxStat, gameState.comprehensiveQuality + effects.comprehensiveQuality);
            }
            if (effects.teacherStrength) {
                gameState.teacherStrength = Math.min(gameState.maxStat, gameState.teacherStrength + effects.teacherStrength);
            }
            if (effects.facilityLevel) {
                gameState.facilityLevel = Math.min(gameState.maxStat, gameState.facilityLevel + effects.facilityLevel);
            }
            if (effects.reputation) {
                gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + effects.reputation);
            }
            
            // é‡æ–°ç”Ÿæˆæ‰€æœ‰å­¦ç”Ÿåˆ†å¸ƒ
            Object.keys(gameState.studentQueue).forEach(key => {
                const studentGroup = gameState.studentQueue[key];
                studentGroup.distribution = generateScoreDistribution(300, studentGroup.avgScore);
                
                // æ›´æ–°å¹³å‡åˆ†
                const newAvgScore = updateStudentAverageScore(studentGroup.distribution);
                studentGroup.avgScore = Math.floor(newAvgScore);
            });
            
            // æ›´æ–°æ˜¾ç¤ºæ•°æ®
            updateCurrentStudentsDisplay();
        }
        
        function showActionResult(action, effects) {
            const modal = document.getElementById('actionResultModal');
            const title = document.getElementById('actionResultTitle');
            const results = document.getElementById('actionResults');
            
            title.textContent = 'âœ¨ è¡ŒåŠ¨å®Œæˆ';
            
            let effectsHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: #4da6ff;">${action.icon}</div>
                    <h3 style="color: #1e5b9e; margin-bottom: 10px;">${action.name}</h3>
                    <p style="color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">${action.description}</p>
                    
                    <div style="background: #f8fdff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3e0ff;">
                        <h4 style="color: #2ecc71; margin-bottom: 15px;">ğŸ¯ è·å¾—æ•ˆæœ</h4>
                        <div class="effect-grid">
            `;
            
            if (effects.comprehensiveQuality) {
                effectsHTML += `
                    <div class="effect-item">
                        <div class="effect-value">+${effects.comprehensiveQuality}</div>
                        <div class="effect-label">ç»¼åˆè´¨é‡</div>
                    </div>
                `;
            }
            if (effects.teacherStrength) {
                effectsHTML += `
                    <div class="effect-item">
                        <div class="effect-value">+${effects.teacherStrength}</div>
                        <div class="effect-label">å¸ˆèµ„åŠ›é‡</div>
                    </div>
                `;
            }
            if (effects.facilityLevel) {
                effectsHTML += `
                    <div class="effect-item">
                        <div class="effect-value">+${effects.facilityLevel}</div>
                        <div class="effect-label">è®¾æ–½ç­‰çº§</div>
                    </div>
                `;
            }
            if (effects.reputation) {
                effectsHTML += `
                    <div class="effect-item">
                        <div class="effect-value">+${effects.reputation}</div>
                        <div class="effect-label">å­¦æ ¡å£°èª‰</div>
                    </div>
                `;
            }
            
            effectsHTML += `
                        </div>
                    </div>
                    <div style="background: #e6f7ff; padding: 15px; border-radius: 10px; border: 1px solid #b3e0ff; margin-top: 15px;">
                        <p style="color: #1e5b9e; font-size: 0.95rem; margin: 0;">
                            å­¦æ ¡ç»¼åˆè¯„åˆ†æå‡è‡³ï¼š<strong>${calculateSchoolScore()}</strong>åˆ†
                        </p>
                        <p style="color: #666; font-size: 0.9rem; margin: 5px 0 0 0;">
                            å½“å‰é«˜ä¸‰å­¦ç”Ÿå¹³å‡åˆ†ï¼š<strong>${Math.floor(gameState.currentStudents.grade3.avgScore)}</strong>åˆ†
                        </p>
                    </div>
                </div>
            `;
            
            results.innerHTML = effectsHTML;
            
            modal.classList.remove('hidden');
        }
        
        // ==================== å¹´ä»½æ¨è¿›ç³»ç»Ÿï¼ˆé‡æ–°è®¾è®¡ï¼‰ ====================
        
        function advanceYear() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€å¹´
            if (gameState.year >= gameState.maxYears) {
                showGameOver();
                return;
            }
            
            // æ”¶å–å­¦è´¹
            collectTuition();
            
            // é«˜ä¸‰å­¦ç”Ÿæ¯•ä¸šï¼ˆä»ç¬¬3å¹´å¼€å§‹ï¼‰
            if (gameState.year >= 3) {
                processGraduation();
            }
            
            // è¿›å…¥ä¸‹ä¸€å¹´
            proceedToNextYear();
        }
        
        function collectTuition() {
            const schoolScore = calculateSchoolScore();
            
            // åŸºç¡€å­¦è´¹ï¼šæ¯äºº1000å…ƒ/å¹´ï¼ˆ0.1ä¸‡ï¼‰
            const baseTuitionPerStudent = 0.1;
            
            // å­¦æ ¡è´¨é‡åŠ æˆï¼šæ¯100åˆ†å¢åŠ 3%å­¦è´¹
            const qualityBonus = 1 + (schoolScore / 100) * 0.03;
            
            // å£°èª‰é¢å¤–åŠ æˆï¼šæ¯100å£°èª‰å¢åŠ 2%å­¦è´¹
            const reputationBonus = 1 + (gameState.reputation / 100) * 0.02;
            
            // è®¡ç®—æ¯åå­¦ç”Ÿå­¦è´¹ï¼ˆä¸‡ï¼‰
            gameState.tuition = baseTuitionPerStudent * qualityBonus * reputationBonus;
            
            // å­¦ç”Ÿæ€»æ•°ï¼š3ä¸ªå¹´çº§ Ã— 300äºº = 900äºº
            const totalStudents = 900;
            
            // å­¦è´¹æ€»æ”¶å…¥
            const tuitionIncome = totalStudents * gameState.tuition;
            
            // ç¡®ä¿å­¦è´¹åœ¨åˆç†èŒƒå›´ï¼š80-140ä¸‡
            const minTuition = 80;
            const maxTuition = 140;
            const finalIncome = Math.max(minTuition, Math.min(maxTuition, tuitionIncome));
            
            // æ·»åŠ æ”¶å…¥
            gameState.money += finalIncome;
            
            // æ›´æ–°æ˜¾ç¤º
            updateTuitionInfo(finalIncome, totalStudents);
            
            return finalIncome;
        }
        
        function processGraduation() {
            // æ‰¾åˆ°å½“å‰é«˜ä¸‰å­¦ç”Ÿ
            let graduatingGroup = null;
            let groupKey = null;
            
            Object.keys(gameState.studentQueue).forEach(key => {
                if (gameState.studentQueue[key].grade === 3) {
                    graduatingGroup = gameState.studentQueue[key];
                    groupKey = key;
                }
            });
            
            if (!graduatingGroup) return;
            
            // è®¡ç®—å½•å–ç»“æœ - åŸºäºå®é™…åˆ†å¸ƒ
            const distribution = graduatingGroup.distribution;
            const results = {
                top: distribution[0]?.count || 0,
                top985: distribution[1]?.count || 0,
                top211: distribution[2]?.count || 0,
                first: distribution[3]?.count || 0,
                undergrad: distribution[4]?.count || 0,
                college: distribution[5]?.count || 0,
                low: distribution[6]?.count || 0,
                total: 300
            };
            
            // è®¡ç®—å®é™…å¹³å‡åˆ†
            let totalScore = 0;
            let totalStudents = 0;
            
            distribution.forEach(range => {
                const rangeMid = (range.min + range.max) / 2;
                totalScore += rangeMid * range.count;
                totalStudents += range.count;
            });
            
            const actualAvgScore = totalStudents > 0 ? totalScore / totalStudents : graduatingGroup.avgScore;
            
            // æ›´æ–°æ¯•ä¸šç”Ÿç»Ÿè®¡
            updateGraduateStats(results, distribution);
            
            // åˆ›å»ºæ¯•ä¸šç”Ÿè®°å½•
            const graduateRecord = {
                year: gameState.year,
                results: results,
                avgScore: Math.floor(actualAvgScore),
                distribution: JSON.parse(JSON.stringify(distribution)),
                schoolStats: {
                    comprehensiveQuality: gameState.comprehensiveQuality,
                    teacherStrength: gameState.teacherStrength,
                    facilityLevel: gameState.facilityLevel,
                    reputation: gameState.reputation
                }
            };
            gameState.graduates.push(graduateRecord);
            
            // è®°å½•å¹´åº¦æ•°æ®
            gameState.graduateStats.yearData.push({
                year: gameState.year,
                avgScore: Math.floor(actualAvgScore),
                topCount: results.top,
                top985Count: results.top985,
                top211Count: results.top211,
                firstCount: results.first,
                undergradCount: results.undergrad,
                collegeCount: results.college,
                lowCount: results.low,
                schoolStats: {
                    comprehensiveQuality: gameState.comprehensiveQuality,
                    teacherStrength: gameState.teacherStrength,
                    facilityLevel: gameState.facilityLevel,
                    reputation: gameState.reputation
                }
            });
            
            // æ˜¾ç¤ºæ¯•ä¸šç”ŸæŠ¥å‘Š
            showGraduateReport(graduateRecord);
            
            // åˆ é™¤æ¯•ä¸šçš„å­¦ç”Ÿç»„
            delete gameState.studentQueue[groupKey];
        }
        
        function updateGraduateStats(results, distribution) {
            gameState.graduateStats.total += results.total;
            gameState.graduateStats.topStudents += results.top;
            gameState.graduateStats.top985 += results.top985;
            gameState.graduateStats.top211 += results.top211;
            gameState.graduateStats.firstTier += results.first;
            gameState.graduateStats.undergraduate += results.undergrad;
            gameState.graduateStats.college += results.college;
            gameState.graduateStats.low += results.low;
            
            // è®°å½•åˆ†æ•°æ®µ
            if (distribution && Array.isArray(distribution)) {
                // æ¸…åŒ—æ®µ
                for (let i = 0; i < results.top; i++) {
                    gameState.graduateStats.scoreSegments.top.push(gameState.year);
                }
                // 985æ®µ
                for (let i = 0; i < results.top985; i++) {
                    gameState.graduateStats.scoreSegments.level985.push(gameState.year);
                }
                // 211æ®µ
                for (let i = 0; i < results.top211; i++) {
                    gameState.graduateStats.scoreSegments.level211.push(gameState.year);
                }
                // ä¸€æœ¬æ®µ
                for (let i = 0; i < results.first; i++) {
                    gameState.graduateStats.scoreSegments.first.push(gameState.year);
                }
                // æœ¬ç§‘æ®µ
                for (let i = 0; i < results.undergrad; i++) {
                    gameState.graduateStats.scoreSegments.undergrad.push(gameState.year);
                }
                // ä¸“ç§‘æ®µ
                for (let i = 0; i < results.college; i++) {
                    gameState.graduateStats.scoreSegments.college.push(gameState.year);
                }
                // è½æ¦œæ®µ
                for (let i = 0; i < results.low; i++) {
                    gameState.graduateStats.scoreSegments.low.push(gameState.year);
                }
            }
            
            // æ›´æ–°å¤§å­¦å…³ç³»ä¸­çš„ç´¯è®¡äººæ•°
            Object.keys(gameState.universityRelations).forEach(universityName => {
                const university = gameState.universityRelations[universityName];
                if (university.tier === 'top') {
                    university.count = gameState.graduateStats.topStudents;
                } else if (university.tier === '985') {
                    university.count = gameState.graduateStats.top985;
                } else if (university.tier === '211') {
                    university.count = gameState.graduateStats.top211;
                } else {
                    university.count = gameState.graduateStats.firstTier;
                }
            });
            
            // ä¼˜è´¨æ¯•ä¸šç”Ÿç»™å­¦æ ¡å¸¦æ¥å£°èª‰å¢ç›Š
            const reputationGain = Math.min(15, 
                results.top * 0.6 +      // æ¸…åŒ—æ¯äºº0.6ç‚¹ - é™ä½
                results.top985 * 0.3 +   // 985æ¯äºº0.3ç‚¹ - é™ä½
                results.top211 * 0.15 +  // 211æ¯äºº0.15ç‚¹ - é™ä½
                results.first * 0.08     // ä¸€æœ¬æ¯äºº0.08ç‚¹ - é™ä½
            );
            gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + Math.floor(reputationGain));
        }
        
        function proceedToNextYear() {
            // å¹´ä»½å¢åŠ 
            gameState.year++;
            
            // é‡ç½®ç²¾åŠ›å€¼
            gameState.energy = 2;
            gameState.actionsTaken = 0;
            gameState.completedActions = new Set();
            
            // å­¦ç”Ÿé˜Ÿåˆ—æ›´æ–°ï¼šæ‰€æœ‰å­¦ç”Ÿå‡ä¸€çº§
            Object.keys(gameState.studentQueue).forEach(key => {
                const studentGroup = gameState.studentQueue[key];
                
                // å¢åŠ å¹´çº§
                studentGroup.grade++;
                
                // è®¡ç®—å¹´åº¦å¢é•¿
                const growth = calculateYearlyGrowth(studentGroup.avgScore, studentGroup.grade);
                studentGroup.avgScore = Math.min(750, studentGroup.avgScore + growth);
                
                // æ›´æ–°åˆ†å¸ƒ
                studentGroup.distribution = generateScoreDistribution(300, studentGroup.avgScore);
            });
            
            // æ‹›æ”¶æ–°ç”Ÿ
            const newStudentScore = calculateNewStudentScore();
            const newKey = `year${gameState.year}`;
            gameState.studentQueue[newKey] = {
                grade: 1,
                avgScore: newStudentScore,
                originalScore: newStudentScore,
                distribution: generateScoreDistribution(300, newStudentScore)
            };
            
            // æ›´æ–°æ˜¾ç¤ºæ•°æ®
            updateCurrentStudentsDisplay();
            
            // æ›´æ–°æ˜¾ç¤º
            updateAllDisplays();
            updateProgressTip();
        }
        
        // ==================== å…¶ä»–å‡½æ•° ====================
        
        function updateProgressTip() {
            const tipElement = document.getElementById('progressTip');
            const year = gameState.year;
            const schoolScore = calculateSchoolScore();
            
            if (year <= 5) {
                tipElement.textContent = "å‰5å¹´ï¼šä»é›¶å¼€å§‹é˜¶æ®µï¼Œé‡ç‚¹æå‡åŸºç¡€æ•™å­¦è´¨é‡ï¼Œç§¯ç´¯å­¦æ ¡æ•°æ®";
            } else if (year <= 10) {
                if (schoolScore >= 400) {
                    tipElement.textContent = "ç¬¬5-10å¹´ï¼šå­¦æ ¡å·²æœ‰ä¸€å®šåŸºç¡€ï¼Œå¼€å§‹æœ‰åŒä¸€æµ/ä¸€æœ¬å­¦ç”Ÿå‡ºç°";
                } else {
                    tipElement.textContent = "ç¬¬5-10å¹´ï¼šç»§ç»­åŠ å¼ºå­¦æ ¡å»ºè®¾ï¼Œäº‰å–æ—©æ—¥è¾¾åˆ°400åˆ†å­¦æ ¡è¯„åˆ†";
                }
            } else if (year <= 15) {
                if (schoolScore >= 600) {
                    tipElement.textContent = "ç¬¬10-15å¹´ï¼šå­¦æ ¡è¿›å…¥å¿«é€Ÿå‘å±•æœŸï¼Œ211/985é«˜æ ¡å¼€å§‹æœ‰çªç ´";
                } else if (schoolScore >= 500) {
                    tipElement.textContent = "ç¬¬10-15å¹´ï¼šå­¦æ ¡å·²æœ‰ä¸é”™çš„åŸºç¡€ï¼Œå¼€å§‹å†²å‡»211é«˜æ ¡";
                } else {
                    tipElement.textContent = "ç¬¬10-15å¹´ï¼šå­¦æ ¡å»ºè®¾éœ€è¦åŠ å¿«ï¼Œé‡ç‚¹æå‡æ ¸å¿ƒæ•°æ®";
                }
            } else if (year <= 20) {
                if (schoolScore >= 800) {
                    tipElement.textContent = "ç¬¬15-20å¹´ï¼šå†²åˆºé˜¶æ®µï¼Œå­¦æ ¡å·²æ˜¯é¡¶å°–æ°´å¹³ï¼Œå…¨åŠ›å†²å‡»æ¸…åŒ—åæ ¡";
                } else if (schoolScore >= 700) {
                    tipElement.textContent = "ç¬¬15-20å¹´ï¼šå­¦æ ¡æ¥è¿‘é¡¶å°–æ°´å¹³ï¼Œç»§ç»­ä¼˜åŒ–å„é¡¹æ•°æ®";
                } else {
                    tipElement.textContent = "ç¬¬15-20å¹´ï¼šæœ€åå†²åˆºé˜¶æ®µï¼Œå…¨åŠ›æå‡å­¦æ ¡æ•´ä½“æ°´å¹³";
                }
            } else if (year <= 25) {
                if (schoolScore >= 900) {
                    tipElement.textContent = "ç¬¬20-25å¹´ï¼šå­¦æ ¡è¾¾åˆ°å·…å³°æ°´å¹³ï¼ŒåŸ¹å…»å‡ºå¤§æ‰¹æ¸…åŒ—å’Œ985å­¦ç”Ÿ";
                } else if (schoolScore >= 800) {
                    tipElement.textContent = "ç¬¬20-25å¹´ï¼šå­¦æ ¡æ¥è¿‘å·…å³°ï¼Œç»§ç»­æå‡å„é¡¹æ•°æ®";
                } else {
                    tipElement.textContent = "ç¬¬20-25å¹´ï¼šç»§ç»­åŠªåŠ›æå‡å­¦æ ¡æ°´å¹³ï¼Œå‘é¡¶å°–åæ ¡è¿ˆè¿›";
                }
            } else {
                if (schoolScore >= 950) {
                    tipElement.textContent = "ç¬¬25-30å¹´ï¼šå­¦æ ¡å·²æˆä¸ºä¼ å¥‡åæ ¡ï¼ŒåŸ¹å…»å‡ºå¤§é‡é¡¶å°–äººæ‰";
                } else if (schoolScore >= 850) {
                    tipElement.textContent = "ç¬¬25-30å¹´ï¼šå­¦æ ¡å·²æ˜¯å…¨å›½é¡¶å°–ï¼Œç»§ç»­å·©å›ºæˆæœ";
                } else {
                    tipElement.textContent = "ç¬¬25-30å¹´ï¼šæœ€åå†²åˆºé˜¶æ®µï¼Œå…¨åŠ›æå‡å­¦æ ¡æ•´ä½“æ°´å¹³";
                }
            }
        }
        
        function updateYearProgress() {
            const progress = (gameState.year / gameState.maxYears) * 100;
            document.getElementById('yearProgress').style.width = `${progress}%`;
        }
        
        // ==================== å¼¹çª—ç³»ç»Ÿ ====================
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function setupModalClickOutside() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                    }
                });
            });
        }
        
        // ==================== å¤§å­¦åˆä½œç³»ç»Ÿ ====================
        
        function renderUniversityTabs() {
            const tabsElement = document.getElementById('universityTabs');
            // æŒ‰è¦æ±‚çš„é¡ºåºï¼šå…¨éƒ¨ â†’ æ¸…åŒ— â†’ 985 â†’ 211 â†’ åŒä¸€æµ
            const categoryOrder = ['all', 'top', '985', '211', 'double'];
            
            tabsElement.innerHTML = categoryOrder.map(id => {
                const category = universityCategories[id];
                return `
                    <button class="category-tab ${gameState.currentUniversityCategory === id ? 'active' : ''}" 
                            onclick="changeUniversityCategory('${id}')">
                        ${category.name}
                    </button>
                `;
            }).join('');
        }
        
        function changeUniversityCategory(category) {
            gameState.currentUniversityCategory = category;
            renderUniversityTabs();
            renderUniversityList();
        }
        
        function renderUniversityList() {
            const listElement = document.getElementById('universityList');
            const universities = Object.entries(gameState.universityRelations);
            
            const tierOrder = { 'top': 0, '985': 1, '211': 2, 'double': 3 };
            
            let filteredUniversities = universities;
            if (gameState.currentUniversityCategory !== 'all') {
                filteredUniversities = universities.filter(([name, data]) => 
                    data.tier === gameState.currentUniversityCategory
                );
            }
            
            filteredUniversities.sort((a, b) => {
                const tierA = tierOrder[a[1].tier];
                const tierB = tierOrder[b[1].tier];
                if (tierA !== tierB) return tierA - tierB;
                
                return a[0].localeCompare(b[0]);
            });
            
            listElement.innerHTML = filteredUniversities.map(([name, data]) => {
                let currentCount = data.count;
                
                let statusText = '';
                let statusClass = 'status-none';
                
                if (data.status === 'partner') {
                    statusText = 'å·²åˆä½œ';
                    statusClass = 'status-partner';
                } else if (data.status === 'special') {
                    statusText = 'ç‰¹æ‹›é€šé“';
                    statusClass = 'status-special';
                } else if (data.status === 'deep') {
                    statusText = 'æ·±åº¦åˆä½œ';
                    statusClass = 'status-deep';
                } else {
                    statusText = `éœ€${data.requirement}äºº`;
                    statusClass = 'status-none';
                }
                
                let tierLabel = '';
                let tierClass = '';
                switch(data.tier) {
                    case 'top': tierLabel = 'æ¸…åŒ—'; tierClass = 'tier-top'; break;
                    case '985': tierLabel = '985'; tierClass = 'tier-985'; break;
                    case '211': tierLabel = '211'; tierClass = 'tier-211'; break;
                    case 'double': tierLabel = 'åŒä¸€æµ'; tierClass = 'tier-double'; break;
                }
                
                const progress = Math.min(100, (currentCount / data.requirement) * 100);
                const canEstablish = currentCount >= data.requirement && data.status === 'none' && gameState.establishedPartnerships < gameState.maxPartnerships;
                const canCancel = data.status !== 'none';
                
                return `
                    <div class="university-item">
                        <div class="university-info">
                            <div class="university-name">
                                <span class="tier-tag ${tierClass}">${tierLabel}</span>
                                ${name}
                            </div>
                            <div class="university-details">
                                ç´¯è®¡ï¼š${currentCount}/${data.requirement}äºº
                                ${data.status !== 'none' ? ` Â· ç‰¹æ‹›ï¼š${data.specialAdmission}äºº` : ''}
                            </div>
                            ${data.status === 'none' ? `
                                <div class="progress-bar" style="margin-top: 6px; height: 5px;">
                                    <div class="progress-fill" style="width: ${progress}%; background: ${universityCategories[data.tier]?.color || '#4da6ff'};"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="university-actions">
                            <div class="university-status ${statusClass}">${statusText}</div>
                            ${canEstablish ? `
                                <button class="university-action-btn" onclick="showUniversityPartnershipModal('${name}')" title="å»ºç«‹åˆä½œå…³ç³»">
                                    åˆä½œ
                                </button>
                            ` : ''}
                            ${canCancel ? `
                                <button class="university-action-btn cancel" onclick="cancelPartnership('${name}')" title="å–æ¶ˆåˆä½œå…³ç³»">
                                    å–æ¶ˆ
                                </button>
                            ` : ''}
                            <button class="university-action-btn detail" onclick="showUniversityDetailModal('${name}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('establishedPartnerships').textContent = gameState.establishedPartnerships;
        }
        
        function updateUniversityRelations() {
            Object.entries(gameState.universityRelations).forEach(([name, data]) => {
                let currentCount = 0;
                if (data.tier === 'top') {
                    currentCount = gameState.graduateStats.topStudents;
                } else if (data.tier === '985') {
                    currentCount = gameState.graduateStats.top985;
                } else if (data.tier === '211') {
                    currentCount = gameState.graduateStats.top211;
                } else {
                    currentCount = gameState.graduateStats.firstTier;
                }
                
                data.count = currentCount;
                
                if (data.status === 'partner' && currentCount >= data.requirement * 2) {
                    data.status = 'special';
                    data.specialAdmission = Math.floor(currentCount / 25);
                } else if (data.status === 'special' && currentCount >= data.requirement * 3) {
                    data.status = 'deep';
                    data.specialAdmission = Math.floor(currentCount / 20);
                }
            });
            
            gameState.establishedPartnerships = Object.values(gameState.universityRelations)
                .filter(uni => uni.status !== 'none').length;
        }
        
        // ==================== æ”¯å‡ºé¡¹ç›®å¼¹çª—ä¼˜åŒ– ====================
        
        function showExtraExpensesModal() {
            const modal = document.getElementById('extraExpenseModal');
            const content = document.getElementById('extraExpenseContent');
            
            if (!modal || !content) return;
            
            const extraExpenses = [
                { icon: 'ğŸ›ï¸', name: 'æ ¡å›­æ–‡åŒ–å»ºè®¾', cost: 15, effect: 'å­¦æ ¡å£°èª‰+8ï¼Œå­¦ç”Ÿæ»¡æ„åº¦æå‡' },
                { icon: 'âš½', name: 'ä½“è‚²è®¾æ–½å®Œå–„', cost: 20, effect: 'è®¾æ–½ç­‰çº§+12ï¼Œå­¦ç”Ÿä½“è´¨æå‡' },
                { icon: 'ğŸ†', name: 'å¥–å­¦é‡‘è®¾ç½®', cost: 25, effect: 'å­¦æ ¡å£°èª‰+10ï¼Œå¸å¼•ä¼˜è´¨ç”Ÿæº' },
                { icon: 'ğŸŒ', name: 'å›½é™…äº¤æµé¡¹ç›®', cost: 40, effect: 'ç»¼åˆæ°´å¹³+8ï¼Œå£°èª‰+15' },
                { icon: 'ğŸ’»', name: 'ä¿¡æ¯åŒ–å»ºè®¾', cost: 35, effect: 'è®¾æ–½ç­‰çº§+18ï¼Œç»¼åˆæ°´å¹³+5' }
            ];
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 15px; color: #4da6ff;">ğŸ’°</div>
                    <h3 style="color: #1e5b9e; margin-bottom: 10px;">å…¶ä»–æ”¯å‡ºé¡¹ç›®</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">è¿™äº›é¡¹ç›®å¯ä»¥ç›´æ¥ä½¿ç”¨èµ„é‡‘è´­ä¹°ï¼Œä¸æ¶ˆè€—ç²¾åŠ›ç‚¹</p>
                    
                    <div class="expense-grid">
                        ${extraExpenses.map(expense => `
                            <div class="expense-item">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${expense.icon}</span>
                                    <div style="flex: 1;">
                                        <div class="expense-header">
                                            <div class="expense-name">${expense.name}</div>
                                            <div class="expense-cost">${expense.cost}ä¸‡</div>
                                        </div>
                                        <div class="expense-effect">${expense.effect}</div>
                                    </div>
                                </div>
                                <button onclick="purchaseExtraExpense('${expense.name}', ${expense.cost})" 
                                        style="padding: 8px 15px; background: ${gameState.money < expense.cost ? '#cccccc' : '#4da6ff'}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; width: 100%;"
                                        ${gameState.money < expense.cost ? 'disabled' : ''}>
                                    ${gameState.money < expense.cost ? 'èµ„é‡‘ä¸è¶³' : 'ç«‹å³è´­ä¹°'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8fdff; border-radius: 10px;">
                        <div style="color: #5d9cec;">å½“å‰å¯ç”¨èµ„é‡‘ï¼š<span style="color: #1e5b9e; font-weight: bold;">${Math.floor(gameState.money)}ä¸‡</span></div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function purchaseExtraExpense(name, cost) {
            if (gameState.money < cost) {
                alert('èµ„é‡‘ä¸è¶³ï¼');
                return;
            }
            
            gameState.money -= cost;
            
            switch(name) {
                case 'æ ¡å›­æ–‡åŒ–å»ºè®¾':
                    gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + 8);
                    break;
                case 'ä½“è‚²è®¾æ–½å®Œå–„':
                    gameState.facilityLevel = Math.min(gameState.maxStat, gameState.facilityLevel + 12);
                    break;
                case 'å¥–å­¦é‡‘è®¾ç½®':
                    gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + 10);
                    break;
                case 'å›½é™…äº¤æµé¡¹ç›®':
                    gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + 15);
                    gameState.comprehensiveQuality = Math.min(gameState.maxStat, gameState.comprehensiveQuality + 8);
                    break;
                case 'ä¿¡æ¯åŒ–å»ºè®¾':
                    gameState.facilityLevel = Math.min(gameState.maxStat, gameState.facilityLevel + 18);
                    gameState.comprehensiveQuality = Math.min(gameState.maxStat, gameState.comprehensiveQuality + 5);
                    break;
            }
            
            // é‡æ–°ç”Ÿæˆå­¦ç”Ÿåˆ†å¸ƒ
            Object.keys(gameState.studentQueue).forEach(key => {
                const studentGroup = gameState.studentQueue[key];
                studentGroup.distribution = generateScoreDistribution(300, studentGroup.avgScore);
                
                // æ›´æ–°å¹³å‡åˆ†
                const newAvgScore = updateStudentAverageScore(studentGroup.distribution);
                studentGroup.avgScore = Math.floor(newAvgScore);
            });
            
            // æ›´æ–°æ˜¾ç¤ºæ•°æ®
            updateCurrentStudentsDisplay();
            
            alert(`ğŸ‰ æˆåŠŸè´­ä¹°"${name}"ï¼\nèŠ±è´¹ï¼š${cost}ä¸‡`);
            closeModal('extraExpenseModal');
            updateAllDisplays();
        }
        
        // ==================== å¤§å­¦åˆä½œå¼¹çª— ====================
        
        function showUniversityPartnershipModal(name) {
            const data = gameState.universityRelations[name];
            if (!data) return;
            
            const modal = document.getElementById('universityPartnershipModal');
            const title = document.getElementById('universityPartnershipTitle');
            const content = document.getElementById('universityPartnershipContent');
            
            if (!modal || !title || !content) return;
            
            title.textContent = `ä¸${name}å»ºç«‹åˆä½œå…³ç³»`;
            
            let tierLabel = '';
            switch(data.tier) {
                case 'top': tierLabel = 'æ¸…åŒ—çº§åˆ«'; break;
                case '985': tierLabel = '985é«˜æ ¡'; break;
                case '211': tierLabel = '211é«˜æ ¡'; break;
                case 'double': tierLabel = 'åŒä¸€æµé«˜æ ¡'; break;
            }
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: #ffd700;">ğŸ“</div>
                    <h3 style="color: #1e5b9e; margin-bottom: 10px;">${name}</h3>
                    <div style="background: #fff9e6; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: inline-block;">
                        <span style="color: #cc7a00; font-weight: bold;">${tierLabel}</span>
                    </div>
                    
                    <div style="background: #f8fdff; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #b3e0ff;">
                        <h4 style="color: #2ecc71; margin-bottom: 15px;">ğŸ“Š åˆä½œæ¡ä»¶</h4>
                        <div style="text-align: left;">
                            <div class="benefit-item">
                                <span class="benefit-name">è¦æ±‚æ¯•ä¸šç”Ÿæ•°é‡</span>
                                <span class="benefit-value">${data.requirement}äºº</span>
                            </div>
                            <div class="benefit-item">
                                <span class="benefit-name">å½“å‰åŸ¹å…»äººæ•°</span>
                                <span class="benefit-value">${data.count}äºº</span>
                            </div>
                            <div class="benefit-item">
                                <span class="benefit-name">è¾¾æˆçŠ¶æ€</span>
                                <span class="benefit-value" style="color: ${data.count >= data.requirement ? '#2ecc71' : '#e74c3c'}">${data.count >= data.requirement ? 'å·²æ»¡è¶³' : 'æœªæ»¡è¶³'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="university-benefits">
                        <h4 style="color: #1e5b9e; margin-bottom: 15px;">ğŸ åˆä½œåå°†è·å¾—ä»¥ä¸‹åŠ æˆ</h4>
                        <div style="text-align: left;">
            `;
            
            if (data.bonus.comprehensiveQuality) {
                content.innerHTML += `
                    <div class="benefit-item">
                        <span class="benefit-name">ç»¼åˆè´¨é‡æå‡</span>
                        <span class="benefit-value">+${data.bonus.comprehensiveQuality}</span>
                    </div>
                `;
            }
            if (data.bonus.teacherStrength) {
                content.innerHTML += `
                    <div class="benefit-item">
                        <span class="benefit-name">å¸ˆèµ„åŠ›é‡æå‡</span>
                        <span class="benefit-value">+${data.bonus.teacherStrength}</span>
                    </div>
                `;
            }
            if (data.bonus.facilityLevel) {
                content.innerHTML += `
                    <div class="benefit-item">
                        <span class="benefit-name">è®¾æ–½ç­‰çº§æå‡</span>
                        <span class="benefit-value">+${data.bonus.facilityLevel}</span>
                    </div>
                `;
            }
            if (data.bonus.reputation) {
                content.innerHTML += `
                    <div class="benefit-item">
                        <span class="benefit-name">å­¦æ ¡å£°èª‰æå‡</span>
                        <span class="benefit-value">+${data.bonus.reputation}</span>
                    </div>
                `;
            }
            if (data.bonus.studentBoost) {
                content.innerHTML += `
                    <div class="benefit-item">
                        <span class="benefit-name">å­¦ç”Ÿæˆç»©åŠ æˆ</span>
                        <span class="benefit-value">+${data.bonus.studentBoost}%</span>
                    </div>
                `;
            }
            
            content.innerHTML += `
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f0fff4; border-radius: 8px; font-size: 0.9rem; color: #666;">
                            ğŸ’¡ åˆä½œåæ¯å¹´å°†æœ‰é¢å¤–${data.specialAdmission || 2}åç‰¹æ‹›åé¢
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        ${data.count >= data.requirement ? 
                            `<button onclick="establishPartnership('${name}')" style="padding: 12px 25px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">ç¡®è®¤å»ºç«‹åˆä½œå…³ç³»</button>` :
                            `<button disabled style="padding: 12px 25px; background: #cccccc; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;">æœªæ»¡è¶³åˆä½œæ¡ä»¶</button>`
                        }
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function establishPartnership(name) {
            const university = gameState.universityRelations[name];
            if (!university) return;
            
            if (university.count >= university.requirement && university.status === 'none') {
                university.status = 'partner';
                gameState.establishedPartnerships++;
                
                if (university.bonus) {
                    if (university.bonus.comprehensiveQuality) {
                        gameState.comprehensiveQuality = Math.min(gameState.maxStat, gameState.comprehensiveQuality + university.bonus.comprehensiveQuality);
                    }
                    if (university.bonus.teacherStrength) {
                        gameState.teacherStrength = Math.min(gameState.maxStat, gameState.teacherStrength + university.bonus.teacherStrength);
                    }
                    if (university.bonus.facilityLevel) {
                        gameState.facilityLevel = Math.min(gameState.maxStat, gameState.facilityLevel + university.bonus.facilityLevel);
                    }
                    if (university.bonus.reputation) {
                        gameState.reputation = Math.min(gameState.maxStat, gameState.reputation + university.bonus.reputation);
                    }
                }
                
                closeModal('universityPartnershipModal');
                alert(`ğŸ‰ æ­å–œï¼æˆåŠŸä¸${name}å»ºç«‹åˆä½œå…³ç³»ï¼\nè·å¾—äº†å±æ€§åŠ æˆï¼`);
                updateAllDisplays();
            }
        }
        
        // ==================== åˆå§‹åŒ–æ¸¸æˆ ====================
        
        function initGame() {
            console.log("å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
            
            loadLegacyData();
            
            initializeStudentData();
            
            updateAllDisplays();
            
            renderActionButtons();
            
            renderUniversityTabs();
            renderUniversityList();
            
            updateProgressTip();
            
            updateYearProgress();
            
            setupModalClickOutside();
            
            console.log("æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼");
            console.log("å­¦æ ¡åˆå§‹è¯„åˆ†ï¼š", calculateSchoolScore());
            console.log("æ–°ç”Ÿåˆå§‹åˆ†æ•°ï¼š", calculateNewStudentScore());
        }
        
        // ==================== é¡µé¢åŠ è½½ ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...");
            initGame();
        });
        
        // ==================== å…¶ä»–å‡½æ•° ====================
        
        function showUniversityDetailModal(name) {
            const data = gameState.universityRelations[name];
            if (!data) return;
            
            const modal = document.getElementById('universityDetailModal');
            const title = document.getElementById('universityDetailTitle');
            const content = document.getElementById('universityDetailContent');
            
            if (!modal || !title || !content) return;
            
            title.textContent = `${name}è¯¦æƒ…`;
            
            let tierLabel = '';
            switch(data.tier) {
                case 'top': tierLabel = 'æ¸…åŒ—çº§åˆ«'; break;
                case '985': tierLabel = '985é«˜æ ¡'; break;
                case '211': tierLabel = '211é«˜æ ¡'; break;
                case 'double': tierLabel = 'åŒä¸€æµé«˜æ ¡'; break;
            }
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: #ffd700;">ğŸ“</div>
                    <h3 style="color: #1e5b9e; margin-bottom: 10px;">${name}</h3>
                    <div style="background: #fff9e6; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: inline-block;">
                        <span style="color: #cc7a00; font-weight: bold;">${tierLabel}</span>
                    </div>
                    
                    <div style="background: #f8fdff; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #b3e0ff;">
                        <h4 style="color: #1e5b9e; margin-bottom: 15px;">ğŸ“Š åŸºæœ¬ä¿¡æ¯</h4>
                        <div style="text-align: left;">
                            <div class="benefit-item">
                                <span class="benefit-name">åˆä½œè¦æ±‚</span>
                                <span class="benefit-value">${data.requirement}åæ¯•ä¸šç”Ÿ</span>
                            </div>
                            <div class="benefit-item">
                                <span class="benefit-name">å½“å‰åŸ¹å…»</span>
                                <span class="benefit-value">${data.count}äºº</span>
                            </div>
                            <div class="benefit-item">
                                <span class="benefit-name">åˆä½œçŠ¶æ€</span>
                                <span class="benefit-value">
                                    ${data.status === 'none' ? 'æœªåˆä½œ' : 
                                      data.status === 'partner' ? 'å·²åˆä½œ' : 
                                      data.status === 'special' ? 'ç‰¹æ‹›é€šé“' : 
                                      'æ·±åº¦åˆä½œ'}
                                </span>
                            </div>
                            ${data.status !== 'none' ? `
                                <div class="benefit-item">
                                    <span class="benefit-name">ç‰¹æ‹›åé¢</span>
                                    <span class="benefit-value">æ¯å¹´${data.specialAdmission}äºº</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${data.status === 'none' ? `
                        <div style="padding: 15px; background: #fff9e6; border-radius: 10px; margin: 15px 0;">
                            <h4 style="color: #cc7a00; margin-bottom: 10px;">ğŸ“ˆ åˆä½œè¿›åº¦</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(100, (data.count / data.requirement) * 100)}%;"></div>
                            </div>
                            <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                                è¿˜éœ€åŸ¹å…»${Math.max(0, data.requirement - data.count)}åæ¯•ä¸šç”Ÿ
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function cancelPartnership(name) {
            const university = gameState.universityRelations[name];
            if (!university || university.status === 'none') return;
            
            if (confirm(`ç¡®å®šè¦å–æ¶ˆä¸${name}çš„åˆä½œå…³ç³»å—ï¼Ÿ`)) {
                university.status = 'none';
                university.specialAdmission = 0;
                gameState.establishedPartnerships--;
                
                if (university.bonus) {
                    if (university.bonus.comprehensiveQuality) {
                        gameState.comprehensiveQuality = Math.max(0, gameState.comprehensiveQuality - university.bonus.comprehensiveQuality);
                    }
                    if (university.bonus.reputation) {
                        gameState.reputation = Math.max(0, gameState.reputation - university.bonus.reputation);
                    }
                }
                
                alert(`å·²å–æ¶ˆä¸${name}çš„åˆä½œå…³ç³»`);
                updateAllDisplays();
            }
        }
        
        function showGraduateReport(graduateRecord) {
            const modal = document.getElementById('graduateReportModal');
            const yearElement = document.getElementById('graduateYear');
            const content = document.getElementById('graduateReportContent');
            
            if (!modal || !yearElement || !content) return;
            
            yearElement.textContent = graduateRecord.year;
            
            let distributionHTML = '';
            if (graduateRecord.distribution && Array.isArray(graduateRecord.distribution)) {
                distributionHTML = graduateRecord.distribution.map(range => {
                    const percentage = (range.count / 300) * 100;
                    let color = '#cccccc';
                    if (range.label.includes('æ¸…åŒ—')) color = '#ff9900';
                    else if (range.label.includes('985')) color = '#ff9966';
                    else if (range.label.includes('211')) color = '#66cc99';
                    else if (range.label.includes('ä¸€æœ¬')) color = '#4da6ff';
                    else if (range.label.includes('æœ¬ç§‘')) color = '#5d9cec';
                    else if (range.label.includes('ä¸“ç§‘')) color = '#b3e0ff';
                    else if (range.label.includes('è½æ¦œ')) color = '#e74c3c';
                    
                    return `
                        <div class="score-row">
                            <div class="score-label">${range.label}</div>
                            <div class="score-bar">
                                <div class="score-fill" style="width: ${percentage}%; background: ${color}"></div>
                            </div>
                            <div class="score-count">${range.count}äºº</div>
                        </div>
                    `;
                }).join('');
            }
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“</div>
                    <h3 style="color: #1e5b9e; margin-bottom: 15px;">ç¬¬${graduateRecord.year}å±Šæ¯•ä¸šç”Ÿæˆç»©æŠ¥å‘Š</h3>
                    
                    <div style="background: #f8fdff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #5d9cec;">å¹³å‡æˆç»©</div>
                                <div style="font-size: 2.5rem; font-weight: bold; color: #2ecc71; margin: 10px 0;">${graduateRecord.avgScore}åˆ†</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #5d9cec;">æ¯•ä¸šç”Ÿæ€»æ•°</div>
                                <div style="font-size: 2.5rem; font-weight: bold; color: #1e5b9e; margin: 10px 0;">300äºº</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fff9e6; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #cc7a00; margin-bottom: 15px;">ğŸ† å½•å–æˆæœ</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #ff9900; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.top || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">æ¸…åŒ—å½•å–</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #ff9966; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.top985 || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">985é«˜æ ¡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #66cc99; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.top211 || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">211é«˜æ ¡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #4da6ff; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.first || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">ä¸€æœ¬é™¢æ ¡</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #5d9cec; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.undergrad || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">æœ¬ç§‘é™¢æ ¡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #b3e0ff; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.college || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">ä¸“ç§‘é™¢æ ¡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <div style="color: #e74c3c; font-weight: bold; font-size: 1.2rem;">${graduateRecord.results.low || 0}äºº</div>
                                <div style="color: #666; font-size: 0.9rem;">è½æ¦œå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0fff4; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #27ae60; margin-bottom: 15px;">ğŸ“Š åˆ†æ•°åˆ†å¸ƒ</h4>
                        ${distributionHTML}
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function showGraduateDataPanel() {
            const modal = document.getElementById('graduateDataModal');
            const content = document.getElementById('graduateDataContent');
            
            if (!modal || !content) return;
            
            if (gameState.graduates.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3rem; color: #b3e0ff;">ğŸ“</div>
                        <h3 style="color: #1e5b9e; margin: 15px 0;">å°šæœªæœ‰æ¯•ä¸šç”Ÿ</h3>
                        <p style="color: #5d9cec; font-size: 1rem;">ç¬¬3å¹´å¼€å§‹ä¼šæœ‰ç¬¬ä¸€æ‰¹å­¦ç”Ÿæ¯•ä¸š</p>
                    </div>
                `;
            } else {
                let yearlyDataHTML = '';
                if (gameState.graduateStats.yearData.length > 0) {
                    yearlyDataHTML = `
                        <div class="data-section">
                            <h4 style="color: #1e5b9e; margin-bottom: 15px;">ğŸ“ˆ å†å¹´æ¯•ä¸šç”Ÿæ•°æ®</h4>
                            <div style="overflow-x: auto;">
                                <table class="yearly-data-table">
                                    <thead>
                                        <tr>
                                            <th>æ¯•ä¸šå¹´ä»½</th>
                                            <th>å¹³å‡åˆ†</th>
                                            <th>æ¸…åŒ—</th>
                                            <th>985</th>
                                            <th>211</th>
                                            <th>ä¸€æœ¬</th>
                                            <th>æœ¬ç§‘</th>
                                            <th>ä¸“ç§‘</th>
                                            <th>è½æ¦œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    gameState.graduateStats.yearData.forEach(data => {
                        yearlyDataHTML += `
                            <tr>
                                <td>ç¬¬${data.year}å±Š</td>
                                <td>${data.avgScore}åˆ†</td>
                                <td>${data.topCount}äºº</td>
                                <td>${data.top985Count}äºº</td>
                                <td>${data.top211Count}äºº</td>
                                <td>${data.firstCount}äºº</td>
                                <td>${data.undergradCount}äºº</td>
                                <td>${data.collegeCount}äºº</td>
                                <td>${data.lowCount}äºº</td>
                            </tr>
                        `;
                    });
                    
                    yearlyDataHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                const latestGraduate = gameState.graduates[gameState.graduates.length - 1];
                
                content.innerHTML = `
                    <div style="max-height: 70vh; overflow-y: auto;">
                        <div class="data-section">
                            <h3 style="color: #1e5b9e; margin-bottom: 20px;">ğŸ“Š æ¯•ä¸šç”Ÿæ•°æ®åˆ†æ</h3>
                            <div style="color: #666; font-size: 0.95rem; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">ç´¯è®¡æ¯•ä¸šç”Ÿ</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #1e5b9e;">${gameState.graduateStats.total}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">æ¸…åŒ—å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #ff9900;">${gameState.graduateStats.topStudents}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">985å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #ff9966;">${gameState.graduateStats.top985}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">211å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #66cc99;">${gameState.graduateStats.top211}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">æœ¬ç§‘å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #5d9cec;">${gameState.graduateStats.undergraduate}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">ä¸“ç§‘å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #b3e0ff;">${gameState.graduateStats.college}äºº</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">ä¸€æœ¬å½•å–</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #4da6ff;">${gameState.graduateStats.firstTier}äºº</div>
                                    </div>
                                    <div style="background: #f8fdff; padding: 15px; border-radius: 8px;">
                                        <div style="color: #5d9cec; font-size: 0.85rem;">è½æ¦œå­¦ç”Ÿ</div>
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #e74c3c;">${gameState.graduateStats.low}äºº</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${yearlyDataHTML}
                        
                        <div class="data-section">
                            <h4 style="color: #1e5b9e; margin-bottom: 15px;">ğŸ¯ æœ€æ–°ä¸€å±Šæ¯•ä¸šç”Ÿè¯¦æƒ…</h4>
                            <div style="color: #666; font-size: 0.95rem;">
                                <div class="stat-row">
                                    <span>æ¯•ä¸šå¹´ä»½</span>
                                    <span>ç¬¬${latestGraduate.year}å±Š</span>
                                </div>
                                <div class="stat-row">
                                    <span>å¹³å‡åˆ†æ•°</span>
                                    <span>${latestGraduate.avgScore}åˆ†</span>
                                </div>
                                <div class="stat-row">
                                    <span>æ¸…åŒ—å½•å–</span>
                                    <span style="color: #ff9900; font-weight: bold;">${latestGraduate.results.top}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>985é«˜æ ¡å½•å–</span>
                                    <span style="color: #ff9966; font-weight: bold;">${latestGraduate.results.top985}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>211é«˜æ ¡å½•å–</span>
                                    <span style="color: #66cc99; font-weight: bold;">${latestGraduate.results.top211}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>ä¸€æœ¬é™¢æ ¡å½•å–</span>
                                    <span style="color: #4da6ff; font-weight: bold;">${latestGraduate.results.first}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>æœ¬ç§‘é™¢æ ¡å½•å–</span>
                                    <span style="color: #5d9cec; font-weight: bold;">${latestGraduate.results.undergrad}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>ä¸“ç§‘é™¢æ ¡å½•å–</span>
                                    <span style="color: #b3e0ff; font-weight: bold;">${latestGraduate.results.college}äºº</span>
                                </div>
                                <div class="stat-row">
                                    <span>è½æ¦œå­¦ç”Ÿ</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${latestGraduate.results.low}äºº</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }
        
        function showGameOver() {
            const modal = document.getElementById('gameOverModal');
            const endingTitle = document.getElementById('endingTitle');
            const endingContent = document.getElementById('endingContent');
            
            if (!modal || !endingTitle || !endingContent) return;
            
            const score = calculateFinalScore();
            const endingData = calculateEnding(score);
            
            endingTitle.textContent = `${endingData.title} - 30å¹´æ ¡é•¿ç”Ÿæ¶¯ç»“æŸ`;
            
            endingContent.innerHTML = `
                <div class="ending-screen">
                    <div class="ending-title">${endingData.title}</div>
                    <div style="color: #5d9cec; font-size: 1.1rem; margin-bottom: 8px;">ç»¼åˆè¯„ä»·ï¼š${endingData.grade}</div>
                    <div class="ending-score">${score.toLocaleString()}åˆ†</div>
                    
                    <div style="background: #f8fdff; padding: 22px; border-radius: 12px; margin: 18px 0; border: 1px solid #b3e0ff;">
                        <p style="color: #666; font-size: 1rem; line-height: 1.6; margin-bottom: 12px;">
                            ${endingData.description}
                        </p>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: #fff9e6; border-radius: 8px;">
                            <div style="color: #cc7a00; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px;">ä½ çš„å‘å±•å€¾å‘ï¼š</div>
                            <div style="font-size: 0.85rem; color: #666;">
                                ${getDevelopmentFocusSummary()}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 18px;">
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="color: #5d9cec; font-size: 0.85rem;">ç´¯è®¡æ¯•ä¸šç”Ÿ</div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: #1e5b9e;">${gameState.graduateStats.total}äºº</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="color: #5d9cec; font-size: 0.85rem;">æ¸…åŒ—å½•å–</div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: #ff9900;">${gameState.graduateStats.topStudents}äºº</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="color: #5d9cec; font-size: 0.85rem;">985å½•å–</div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: #ff9966;">${gameState.graduateStats.top985}äºº</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px;">
                                <div style="color: #5d9cec; font-size: 0.85rem;">211å½•å–</div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: #66cc99;">${gameState.graduateStats.top211}äºº</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #e6f7ff; border-radius: 8px;">
                            <div style="text-align: center; color: #1e5b9e; font-weight: bold; font-size: 1.1rem;">
                                æœ€ç»ˆå­¦æ ¡è¯„åˆ†ï¼š${calculateSchoolScore()}åˆ†
                            </div>
                            <div style="text-align: center; color: #5d9cec; font-size: 0.9rem; margin-top: 5px;">
                                ç»¼åˆè´¨é‡ ${gameState.comprehensiveQuality} Â· å¸ˆèµ„åŠ›é‡ ${gameState.teacherStrength}<br>
                                è®¾æ–½ç­‰çº§ ${gameState.facilityLevel} Â· å­¦æ ¡å£°èª‰ ${gameState.reputation}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            saveLegacyData(score);
        }
        
        function getDevelopmentFocusSummary() {
            const focus = gameState.developmentFocus;
            const total = focus.balanced + focus.teaching + focus.facilities + focus.reputation;
            
            if (total === 0) return "æœªé€‰æ‹©æ˜ç¡®å‘å±•å€¾å‘";
            
            const balancedPercent = Math.round((focus.balanced / total) * 100);
            const teachingPercent = Math.round((focus.teaching / total) * 100);
            const facilitiesPercent = Math.round((focus.facilities / total) * 100);
            const reputationPercent = Math.round((focus.reputation / total) * 100);
            
            // æ‰¾å‡ºä¸»å¯¼å€¾å‘
            const maxValue = Math.max(balancedPercent, teachingPercent, facilitiesPercent, reputationPercent);
            
            let mainFocus = "";
            if (maxValue === balancedPercent) mainFocus = "å¹³è¡¡å‘å±•å‹";
            else if (maxValue === teachingPercent) mainFocus = "æ•™å­¦å¯¼å‘å‹";
            else if (maxValue === facilitiesPercent) mainFocus = "è®¾æ–½å¯¼å‘å‹";
            else mainFocus = "å£°èª‰å¯¼å‘å‹";
            
            return `${mainFocus}ï¼ˆå¹³è¡¡${balancedPercent}% æ•™å­¦${teachingPercent}% è®¾æ–½${facilitiesPercent}% å£°èª‰${reputationPercent}%ï¼‰`;
        }
        
        function calculateFinalScore() {
            let score = 0;
            
            const schoolScore = calculateSchoolScore();
            score += schoolScore * 6; // é™ä½å­¦æ ¡è¯„åˆ†æƒé‡
            
            const graduateScore = 
                gameState.graduateStats.topStudents * 120 +  // é™ä½æƒé‡
                gameState.graduateStats.top985 * 50 +        // é™ä½æƒé‡
                gameState.graduateStats.top211 * 28 +        // é™ä½æƒé‡
                gameState.graduateStats.firstTier * 12 +     // é™ä½æƒé‡
                gameState.graduateStats.undergraduate * 4 +  // é™ä½æƒé‡
                gameState.graduateStats.college * 1;         // é™ä½æƒé‡
            score += Math.min(12000, graduateScore);         // é™ä½ä¸Šé™
            
            score += gameState.establishedPartnerships * 80; // é™ä½æƒé‡
            
            score += Math.min(800, gameState.money * 0.4);   // é™ä½æƒé‡
            
            // æ ¹æ®å‘å±•å€¾å‘ç»™äºˆé¢å¤–åˆ†æ•°
            const focus = gameState.developmentFocus;
            const totalFocus = focus.balanced + focus.teaching + focus.facilities + focus.reputation;
            if (totalFocus > 0) {
                // å¹³è¡¡å‘å±•å‹ç»™äºˆæœ€é«˜å¥–åŠ±
                const balancedBonus = Math.min(500, (focus.balanced / totalFocus) * 1000);
                score += balancedBonus;
            }
            
            return Math.floor(score);
        }
        
        function calculateEnding(score) {
            const schoolScore = calculateSchoolScore();
            const hasTopGraduates = gameState.graduateStats.topStudents > 25;
            const has985Graduates = gameState.graduateStats.top985 > 60;
            const has211Graduates = gameState.graduateStats.top211 > 120;
            
            // æ ¹æ®å‘å±•å€¾å‘è°ƒæ•´ç»“å±€
            const focus = gameState.developmentFocus;
            const totalFocus = focus.balanced + focus.teaching + focus.facilities + focus.reputation;
            let focusBonus = 0;
            if (totalFocus > 0) {
                // å¹³è¡¡å‘å±•å‹æ›´å®¹æ˜“è·å¾—é«˜è¯„ä»·
                focusBonus = (focus.balanced / totalFocus) * 0.2;
            }
            
            const adjustedScore = score * (1 + focusBonus);
            
            // ç»“å±€åˆ¤æ–­æ ‡å‡†å¤§å¹…æé«˜ï¼Œå¢åŠ åŒºåˆ†åº¦
            if (adjustedScore >= 25000 && schoolScore >= 900 && hasTopGraduates && has985Graduates) {
                return {
                    title: 'ğŸ† ä¼ å¥‡æ ¡é•¿',
                    grade: 'SSSçº§',
                    description: 'ä½ æ‰“é€ äº†ä¸€æ‰€çœŸæ­£çš„ä¼ å¥‡åæ ¡ï¼30å¹´çš„è¾›å‹¤ä»˜å‡ºï¼Œå­¦æ ¡æ•°æ®å’Œæ¯•ä¸šç”Ÿæˆå°±éƒ½è¾¾åˆ°äº†æè‡´æ°´å¹³ï¼Œä½ çš„åå­—å°†æ°¸è½½æ•™è‚²å²å†Œï¼'
                };
            } else if (adjustedScore >= 18000 && schoolScore >= 750 && (hasTopGraduates || has985Graduates)) {
                return {
                    title: 'â­ å“è¶Šæ ¡é•¿',
                    grade: 'Sçº§',
                    description: 'æ­å–œï¼ç»è¿‡30å¹´çš„åŠªåŠ›ï¼Œä½ æˆåŠŸæ‰“é€ äº†ä¸€æ‰€å…¨å›½çŸ¥åçš„é¡¶å°–å­¦æ ¡ï¼å­¦æ ¡æ•°æ®å’Œæ¯•ä¸šç”Ÿæˆå°±éƒ½éå¸¸å‡ºè‰²ï¼'
                };
            } else if (adjustedScore >= 12000 && schoolScore >= 600 && has211Graduates) {
                return {
                    title: 'ğŸ¯ ä¼˜ç§€æ ¡é•¿',
                    grade: 'Açº§',
                    description: '30å¹´çš„è¾›å‹¤ä»˜å‡ºå–å¾—äº†ä¸°ç¡•æˆæœï¼ä½ çš„å­¦æ ¡å·²ç»æˆä¸ºåœ°åŒºåæ ¡ï¼ŒåŸ¹å…»äº†å¤§é‡ä¼˜ç§€äººæ‰ï¼'
                };
            } else if (adjustedScore >= 8000 && schoolScore >= 450) {
                return {
                    title: 'ğŸ‘ åˆæ ¼æ ¡é•¿',
                    grade: 'Bçº§',
                    description: 'ç»è¿‡30å¹´çš„åŠªåŠ›ï¼Œå­¦æ ¡å–å¾—äº†ä¸é”™çš„æˆç»©ï¼ŒåŸ¹å…»äº†ä¸€æ‰¹åˆæ ¼çš„å­¦ç”Ÿï¼Œå®Œæˆäº†åŸºæœ¬çš„æ•™è‚²ä½¿å‘½ã€‚'
                };
            } else if (adjustedScore >= 4000) {
                return {
                    title: 'ğŸ“š æ™®é€šæ ¡é•¿',
                    grade: 'Cçº§',
                    description: '30å¹´çš„æ ¡é•¿ç”Ÿæ¶¯ç»“æŸäº†ï¼Œå­¦æ ¡è™½ç„¶æœ‰ä¸€äº›è¿›æ­¥ï¼Œä½†ç¦»åæ ¡è¿˜æœ‰ä¸€å®šè·ç¦»ã€‚æ•™è‚²ä¹‹è·¯ä»»é‡é“è¿œï¼'
                };
            } else {
                return {
                    title: 'ğŸ’¼ åŸºç¡€æ ¡é•¿',
                    grade: 'Dçº§',
                    description: 'æ ¡é•¿ç”Ÿæ¶¯ç»“æŸäº†ï¼Œå­¦æ ¡çš„åŸºç¡€å»ºè®¾è¿˜éœ€è¦åŠ å¼ºï¼Œæ•™è‚²è´¨é‡æœ‰å¾…æå‡ã€‚'
                };
            }
        }
        
        function loadLegacyData() {
            const legacyData = localStorage.getItem('schoolGame_legacy');
            if (legacyData) {
                try {
                    const legacy = JSON.parse(legacyData);
                    if (legacy.score >= 3000) {
                        gameState.newGamePlus = true;
                    }
                } catch (e) {
                    console.log('ç»§æ‰¿æ•°æ®è¯»å–å¤±è´¥:', e);
                }
            }
        }
        
        function saveLegacyData(score) {
            const legacyData = {
                score: gameState.legacyScore + score,
                graduates: gameState.graduateStats.total,
                topStudents: gameState.graduateStats.topStudents,
                date: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('schoolGame_legacy', JSON.stringify(legacyData));
            } catch (e) {
                console.log('ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥:', e);
            }
        }
        
        function startNewGameWithLegacy() {
            location.reload();
        }
    </script>
</body>
</html>
